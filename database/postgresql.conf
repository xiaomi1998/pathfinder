# ==========================================
# Pathfinder PostgreSQL 性能优化配置
# ==========================================
# 针对 Pathfinder 应用的 PostgreSQL 配置优化

# ==========================================
# 连接和认证
# ==========================================
listen_addresses = '*'
port = 5432
max_connections = 200

# 连接池配置
superuser_reserved_connections = 3

# ==========================================
# 内存配置
# ==========================================
# 共享缓冲区 (应用总内存的 25%)
shared_buffers = 256MB

# 有效缓存大小 (系统总内存的 75%)
effective_cache_size = 1GB

# 工作内存 (每个排序/哈希操作)
work_mem = 4MB

# 维护工作内存 (VACUUM, CREATE INDEX 等)
maintenance_work_mem = 64MB

# 自动 VACUUM 内存
autovacuum_work_mem = 32MB

# ==========================================
# WAL (Write-Ahead Logging) 配置
# ==========================================
# WAL 缓冲区
wal_buffers = 16MB

# WAL 段大小
wal_segment_size = 16MB

# 检查点配置
checkpoint_timeout = 10min
checkpoint_completion_target = 0.9
checkpoint_warning = 30s

# WAL 写入设置
synchronous_commit = on
wal_sync_method = fsync

# ==========================================
# 查询规划器配置
# ==========================================
# 统计目标 (影响查询计划准确性)
default_statistics_target = 100

# 随机页面访问成本 (SSD 优化)
random_page_cost = 1.1

# 顺序页面访问成本
seq_page_cost = 1.0

# CPU 处理成本
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# 并行查询配置
max_parallel_workers = 4
max_parallel_workers_per_gather = 2
parallel_tuple_cost = 0.1
parallel_setup_cost = 1000.0

# 有效IO并发度 (SSD 优化)
effective_io_concurrency = 200

# ==========================================
# 日志配置
# ==========================================
# 日志级别
log_min_messages = warning
log_min_error_statement = error

# 慢查询日志
log_min_duration_statement = 1000
log_checkpoints = on
log_connections = off
log_disconnections = off
log_lock_waits = on

# 日志行前缀
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# 日志目标
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# ==========================================
# 自动 VACUUM 配置
# ==========================================
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min

# VACUUM 阈值
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.2

# ANALYZE 阈值
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.1

# VACUUM 成本延迟
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 200

# ==========================================
# 锁配置
# ==========================================
max_locks_per_transaction = 64
max_pred_locks_per_transaction = 64
deadlock_timeout = 1s

# ==========================================
# 统计收集配置
# ==========================================
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# 语句统计 (需要 pg_stat_statements 扩展)
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.save = on

# ==========================================
# 后台写入器配置
# ==========================================
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0
bgwriter_flush_after = 512kB

# ==========================================
# 时区和本地化
# ==========================================
timezone = 'Asia/Shanghai'
log_timezone = 'Asia/Shanghai'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# ==========================================
# 扩展配置
# ==========================================
# 自动扩展配置
shared_preload_libraries = 'pg_stat_statements'

# JIT 编译 (PostgreSQL 11+)
jit = on
jit_above_cost = 100000
jit_inline_above_cost = 500000
jit_optimize_above_cost = 500000

# ==========================================
# 应用特定优化
# ==========================================
# JSON 查询优化
gin_pending_list_limit = 4MB

# 全文搜索优化
default_text_search_config = 'english'

# ==========================================
# 资源限制
# ==========================================
# 临时文件限制
temp_file_limit = 1GB

# 语句超时
statement_timeout = 300000  # 5 分钟
lock_timeout = 60000       # 1 分钟
idle_in_transaction_session_timeout = 300000  # 5 分钟

# ==========================================
# 开发环境特定配置
# ==========================================
# 在生产环境中应该禁用这些设置
# log_statement = 'all'
# log_min_duration_statement = 0
# debug_print_plan = off
# debug_print_parse = off

# ==========================================
# 备份和恢复优化
# ==========================================
archive_mode = off
# 在生产环境中启用归档
# archive_mode = on
# archive_command = 'cp %p /var/lib/postgresql/archive/%f'
# archive_timeout = 1800

# ==========================================
# SSL 配置 (生产环境)
# ==========================================
ssl = off
# 在生产环境中启用 SSL
# ssl = on
# ssl_cert_file = 'server.crt'
# ssl_key_file = 'server.key'
# ssl_ca_file = 'ca.crt'