# Claude Code 飞书权限管理器 - 飞书应用配置指南

## 1. 创建飞书机器人

### 步骤 1: 进入飞书开放平台
1. 访问 [飞书开放平台](https://open.feishu.cn/)
2. 登录你的飞书账号
3. 点击"创建应用" -> "机器人"

### 步骤 2: 配置基本信息
- **应用名称**: Claude Code 权限管理器
- **应用描述**: 用于Claude Code权限请求的自动化审批
- **应用图标**: 可选择机器人相关图标

### 步骤 3: 配置权限
在"权限配置"页面，需要添加以下权限：
- `im:message` - 发送消息
- `im:message.group_at_msg` - 群组@消息
- `im:message.p2p_msg` - 私聊消息
- `contact:user.id:readonly` - 获取用户ID

## 2. 配置 Webhook

### 步骤 1: 设置事件订阅
1. 进入"事件订阅"页面
2. 开启"启用事件订阅"
3. 配置请求地址: `http://你的服务器IP:3000/webhook`
4. 添加订阅事件:
   - `im.message.receive_v1` - 接收消息
   - `card.action.trigger` - 交互式卡片操作

### 步骤 2: 配置机器人设置
1. 进入"机器人"页面
2. 开启"启用机器人能力"
3. 配置消息卡片请求网址: `http://你的服务器IP:3000/webhook`

## 3. 获取必要信息

### 获取 App ID 和 App Secret
1. 在应用管理页面，找到"凭证与基础信息"
2. 记录下 **App ID** 和 **App Secret**

### 获取 Webhook URL
1. 在"机器人"页面，找到 **Webhook地址**
2. 格式类似: `https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxxx`

### 获取 Bot Token
1. 安装应用后，在"机器人"页面可以看到 **Bot Token**
2. 格式类似: `bot-xxxxxxxxxxxxxxxxxxxxx`

## 4. 部署配置

### 配置文件设置
编辑 `claude-permission-config.json`：

\`\`\`json
{
  "feishuWebhook": "https://open.feishu.cn/open-apis/bot/v2/hook/你的webhook地址",
  "feishuToken": "你的bot令牌",
  "appId": "你的App ID",
  "appSecret": "你的App Secret"
}
\`\`\`

### 启动 Webhook 处理器
\`\`\`bash
# 启动webhook处理服务
node feishu-webhook-handler.js 3000

# 或者使用后台运行
nohup node feishu-webhook-handler.js 3000 > webhook.log 2>&1 &
\`\`\`

## 5. 测试配置

### 测试 Webhook 连接
\`\`\`bash
# 测试权限请求
node claude-permission-manager.js "ls -la" "测试权限请求"
\`\`\`

### 测试消息发送
如果配置正确，你应该会在飞书中收到类似这样的消息：

---
🤖 **Claude Code 权限请求**

**命令**: ls -la  
**原因**: 测试权限请求  

请选择是否允许执行此命令？

[✅ 允许] [❌ 拒绝]
---

## 6. 高级配置

### 自定义权限规则
你可以在 `claude-permission-config.json` 中自定义权限规则：

\`\`\`json
{
  "permissionRules": {
    "直接允许的安全命令": [
      "Read(.*)",
      "Bash(ls.*)",
      "Bash(pwd)"
    ],
    "需要审批的高风险命令": [
      "Bash(rm -rf.*)",
      "Bash(sudo.*)"
    ]
  }
}
\`\`\`

### 设置消息模板
你可以自定义发送给飞书的消息格式和按钮样式。

## 7. 故障排查

### 常见问题

1. **消息发送失败**
   - 检查 Webhook URL 是否正确
   - 确认机器人已添加到群组或已获得私聊权限

2. **按钮回调不生效**
   - 确认事件订阅配置正确
   - 检查 webhook 处理器是否正在运行

3. **权限请求超时**
   - 调整 `timeout` 配置 (默认 5 分钟)
   - 检查网络连接

### 调试信息
启用详细日志：
\`\`\`bash
DEBUG=true node feishu-webhook-handler.js 3000
\`\`\`

## 8. 安全建议

1. **使用 HTTPS**: 生产环境建议使用 HTTPS 端点
2. **IP 白名单**: 配置服务器防火墙，只允许飞书服务器 IP 访问
3. **验证签名**: 实现飞书请求签名验证（可选）
4. **敏感信息保护**: 避免在消息中展示敏感的命令参数

---

配置完成后，Claude Code 将在遇到需要权限的操作时自动发送飞书消息，你可以通过点击按钮来批准或拒绝操作！