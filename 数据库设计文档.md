# Pathfinder 数据库设计完整文档

## 📋 目录
1. [数据库概览](#数据库概览)
2. [核心业务模块](#核心业务模块)  
3. [完整表结构详细说明](#完整表结构详细说明)
4. [表关系分析](#表关系分析)
5. [ER图 (实体关系图)](#er图-实体关系图)
6. [枚举类型定义](#枚举类型定义)
7. [业务逻辑关系说明](#业务逻辑关系说明)
8. [重要配置和限制](#重要配置和限制)

---

## 1. 数据库概览

**Pathfinder** 是一个企业级营销漏斗分析和管理平台，采用现代化的数据库设计，支持多租户架构、AI智能分析、实时数据处理等核心功能。

### 技术栈配置
- **数据库类型**: PostgreSQL 15+
- **ORM框架**: Prisma 5.x
- **主键策略**: UUID (使用 `gen_random_uuid()`)
- **时间戳**: TIMESTAMPTZ(6) 带时区
- **JSON支持**: 原生JSON字段存储复杂数据
- **多租户**: 基于组织ID的数据隔离

### 核心数据表统计
- **总表数**: 23个核心业务表
- **主要实体**: 8个核心业务实体
- **关系表**: 6个中间关系表  
- **系统表**: 9个管理和日志表
- **索引总数**: 120+ 个优化索引
- **枚举类型**: 13个业务枚举

---

## 2. 核心业务模块

### 🏢 **组织架构管理模块**
管理多租户组织结构和用户权限

**核心表**:
- `industries` - 行业分类标准库
- `organizations` - 企业/组织信息表
- `users` - 用户账户和权限表
- `org_usage_limits` - 组织资源配额控制表

**功能特性**:
- 支持多行业分类和本地化显示
- 灵活的用户角色权限体系 (owner/admin/member)
- 基于订阅计划的资源配额管理
- 完整的组织信息管理 (规模、地区、销售模式等)

### 🔄 **漏斗设计管理模块**
可视化漏斗构建和模板管理

**核心表**:
- `funnels` - 漏斗设计主表
- `nodes` - 漏斗节点详情表
- `edges` - 节点连接关系表
- `funnel_templates` - 漏斗模板库表
- `funnel_instances` - 漏斗运营实例表

**功能特性**:
- 拖拽式可视化漏斗设计器
- 丰富的预定义漏斗模板库
- 支持5种节点类型 (认知/获取/激活/收入/留存)
- 模板实例化和版本管理
- 标签分类和搜索功能

### 📊 **数据分析统计模块**
多维度数据采集和指标分析

**核心表**:
- `node_data` - 节点业务数据表 (周度统计)
- `funnel_metrics` - 漏斗综合指标表
- `node_metrics` - 节点详细指标表
- `funnel_instance_metrics` - 实例运营指标表
- `metric_datasets` - 外部数据源配置表

**功能特性**:
- 支持日/周/月多周期数据统计
- 15+核心业务指标 (转化率、ROI、停留时间等)
- 外部数据源集成能力
- 自定义指标扩展支持
- 实时数据更新和历史趋势分析

### 🤖 **AI智能助手模块**
AI驱动的智能分析和建议系统

**核心表**:
- `ai_sessions` - AI对话会话表
- `ai_messages` - AI消息内容表
- `user_ai_usage` - AI使用情况统计表
- `user_ai_limits` - AI使用配额限制表
- `advice_rules` - 智能建议规则表

**功能特性**:
- 上下文感知的AI对话系统
- 智能漏斗分析和优化建议
- 使用配额管理 (默认每日100次，每月3000次)
- 成本追踪和token统计
- 可定制的业务规则引擎

### 📈 **基准对比分析模块**
行业基准数据和对比分析

**核心表**:
- `benchmark_data` - 行业基准数据表
- `advice_rules` - 智能建议规则表

**功能特性**:
- 丰富的行业基准数据库
- 多维度对比分析 (行业、规模、地区)
- 智能基准匹配和建议
- 自定义基准数据导入

### 🔐 **系统管理审计模块**
管理员后台和完整审计追踪

**核心表**:
- `admin_users` - 系统管理员表
- `admin_operation_logs` - 管理员操作日志表
- `audit_log` - 系统级数据变更审计表

**功能特性**:
- 独立的管理员账户体系
- 完整的操作行为审计
- 数据变更历史追踪
- IP和设备信息记录

---

## 3. 完整表结构详细说明

### 3.1 组织架构管理表

#### **industries（行业信息表）**
**用途**: 存储标准化的行业分类信息，支持国际化显示

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 行业主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一行业标识符 |
| code | 行业代码 | VARCHAR(50) | UNIQUE, 非空 | - | 标准行业分类代码，如 "TECH", "RETAIL" |
| name | 中文名称 | VARCHAR(100) | 非空 | - | 行业中文显示名称 |
| nameEn | 英文名称 | VARCHAR(100) | 可空 | - | 行业英文显示名称，支持国际化 |
| description | 行业描述 | TEXT | 可空 | - | 行业详细介绍和特征描述 |
| isActive | 启用状态 | BOOLEAN | 非空 | true | 控制行业是否在前端显示 |
| sortOrder | 显示排序 | INTEGER | 非空 | 0 | 前端列表显示的排序权重 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 记录创建的精确时间戳 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 记录最后修改时间，自动维护 |

**索引策略**:
- `code` - 唯一索引，支持快速代码查询
- `isActive` - 条件索引，优化活跃行业查询  
- `sortOrder` - 排序索引，优化列表排序性能

**业务关系**: 
- 一对多 → `organizations` (一个行业包含多个组织)

---

#### **organizations（组织机构表）**
**用途**: 存储企业或团队的完整信息和配置

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 组织主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一组织标识符 |
| name | 组织名称 | VARCHAR(100) | 非空 | - | 企业或团队的正式名称 |
| slug | URL标识符 | VARCHAR(50) | UNIQUE, 非空 | - | URL友好的唯一标识符，用于路由 |
| description | 组织描述 | TEXT | 可空 | - | 组织详细介绍和业务描述 |
| industryId | 所属行业 | UUID | FK, 可空 | - | 关联 industries 表的行业分类 |
| companySize | 公司规模 | CompanySize枚举 | 可空 | - | 员工人数规模分类 |
| location | 地理位置 | VARCHAR(100) | 可空 | - | 主要办公地点或服务区域 |
| salesModel | 销售模式 | SalesModel枚举 | 可空 | - | B2B 或 B2C 业务模式标识 |
| planType | 订阅计划 | VARCHAR(20) | 非空 | "free" | 当前订阅的服务计划类型 |
| isActive | 组织状态 | BOOLEAN | 非空 | true | 组织账户是否处于活跃状态 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 组织注册时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 信息最后修改时间 |

**索引策略**:
- `slug` - 唯一索引，支持URL路由查询
- `planType` - 条件索引，按计划类型分组查询
- `isActive` - 状态索引，过滤活跃组织
- `industryId` - 外键索引，按行业分类查询
- `companySize` - 枚举索引，按规模筛选
- `salesModel` - 业务模式索引
- `createdAt` - 时间索引，支持时间范围查询

**业务关系**:
- 多对一 → `industries` (所属行业分类)
- 一对多 → `users`, `funnels`, `funnel_templates`, `metric_datasets`, `benchmark_data`, `advice_rules`, `funnel_instances`
- 一对一 → `org_usage_limits` (资源配额限制)

---

#### **users（用户表）**
**用途**: 存储系统用户的身份信息、权限和状态

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 用户主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一用户标识符 |
| username | 用户名 | VARCHAR(50) | UNIQUE, 非空 | - | 全局唯一的用户登录名 |
| email | 电子邮箱 | VARCHAR(255) | UNIQUE, 可空 | - | 用户邮箱地址，支持邮箱登录 |
| phone | 手机号码 | VARCHAR(20) | UNIQUE, 可空 | - | 用户手机号，支持手机登录 |
| passwordHash | 密码哈希 | VARCHAR(255) | 非空 | - | 使用bcrypt等算法加密的密码 |
| firstName | 用户名字 | VARCHAR(50) | 可空 | - | 用户的名字部分 |
| lastName | 用户姓氏 | VARCHAR(50) | 可空 | - | 用户的姓氏部分 |
| avatar | 头像地址 | VARCHAR(500) | 可空 | - | 用户头像图片的URL地址 |
| organizationId | 所属组织 | UUID | FK, 可空 | - | 关联的组织ID，可以为独立用户 |
| role | 用户角色 | UserRole枚举 | 非空 | member | 在组织中的权限角色 |
| isActive | 账户状态 | BOOLEAN | 非空 | true | 账户是否处于可用状态 |
| isEmailVerified | 邮箱验证 | BOOLEAN | 非空 | false | 邮箱地址是否已通过验证 |
| lastLoginAt | 最后登录 | TIMESTAMPTZ(6) | 可空 | - | 用户最后一次登录的时间 |
| createdAt | 注册时间 | TIMESTAMPTZ(6) | 非空 | now() | 用户账户创建时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 用户信息最后修改时间 |

**索引策略**:
- `username` - 唯一索引，登录查询优化
- `email` - 唯一索引，邮箱登录支持
- `phone` - 唯一索引，手机登录支持
- `organizationId` - 外键索引，组织用户查询
- `role` - 角色索引，权限过滤查询
- `isActive` - 状态索引，过滤活跃用户
- `lastLoginAt` - 时间索引，活跃度分析
- `[username, firstName, lastName]` - 复合索引，用户搜索优化

**业务关系**:
- 多对一 → `organizations` (所属组织)
- 一对多 → `funnels`, `funnel_templates`, `metric_datasets`, `advice_rules`, `ai_sessions`, `user_ai_usage`, `funnel_instances`
- 一对一 → `user_ai_limits` (AI使用限制)

---

#### **org_usage_limits（组织使用限制表）**
**用途**: 管理组织的资源配额和使用限制，支持不同订阅计划

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 限制主键 | CUID | PK, 非空 | cuid() | 使用CUID格式的唯一标识符 |
| organizationId | 组织ID | UUID | FK, UNIQUE, 非空 | - | 关联的组织，一对一关系 |
| maxFunnels | 漏斗数限制 | INTEGER | 非空 | 10 | 可创建的最大漏斗数量 |
| maxTemplates | 模板数限制 | INTEGER | 非空 | 5 | 可创建的最大模板数量 |
| maxInstances | 实例数限制 | INTEGER | 非空 | 50 | 可创建的最大漏斗实例数量 |
| maxUsers | 用户数限制 | INTEGER | 非空 | 5 | 组织可容纳的最大用户数 |
| currentFunnels | 当前漏斗数 | INTEGER | 非空 | 0 | 组织当前已创建的漏斗数量 |
| currentTemplates | 当前模板数 | INTEGER | 非空 | 0 | 组织当前已创建的模板数量 |
| currentInstances | 当前实例数 | INTEGER | 非空 | 0 | 组织当前已创建的实例数量 |
| currentUsers | 当前用户数 | INTEGER | 非空 | 0 | 组织当前的用户数量 |
| planType | 计划类型 | VARCHAR(20) | 非空 | "free" | 当前订阅的计划类型 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 限制规则创建时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 限制规则最后修改时间 |

**索引策略**:
- `organizationId` - 唯一索引，确保一对一关系
- `planType` - 计划类型索引，按计划查询
- `currentFunnels`, `currentTemplates`, `currentInstances`, `currentUsers` - 使用量监控索引

**业务关系**:
- 一对一 → `organizations` (组织资源限制)

---

### 3.2 漏斗设计管理表

#### **funnels（漏斗设计表）**
**用途**: 存储用户创建的漏斗设计方案和配置信息

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 漏斗主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一漏斗标识符 |
| userId | 创建用户 | UUID | FK, 非空 | - | 关联创建该漏斗的用户 |
| organizationId | 所属组织 | UUID | FK, 可空 | - | 关联的组织，支持个人和组织漏斗 |
| name | 漏斗名称 | VARCHAR(100) | 非空 | - | 漏斗的显示名称 |
| description | 漏斗描述 | TEXT | 可空 | - | 漏斗用途和设计思路的详细说明 |
| canvasData | 画布数据 | JSON | 可空 | - | 可视化编辑器的画布布局和样式数据 |
| status | 漏斗状态 | FunnelStatus枚举 | 非空 | active | 漏斗当前状态 (活跃/归档/模板) |
| isTemplate | 模板标识 | BOOLEAN | 非空 | false | 标识是否为可复用的模板漏斗 |
| dataPeriod | 数据周期 | DataPeriod枚举 | 非空 | DAILY | 数据统计和分析的时间粒度 |
| tags | 分类标签 | String[] | 非空 | [] | 用于分类和搜索的标签数组 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 漏斗创建时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 漏斗最后修改时间 |

**索引策略**:
- `userId` - 用户漏斗查询索引
- `organizationId` - 组织漏斗查询索引
- `name` - 名称搜索索引
- `status` - 状态过滤索引
- `isTemplate` - 模板筛选索引
- `tags` - 标签搜索索引
- `createdAt` - 时间排序索引
- `[userId, status]` - 用户状态复合索引
- `[organizationId, status]` - 组织状态复合索引

**业务关系**:
- 多对一 → `users` (创建者), `organizations` (所属组织)
- 一对多 → `nodes`, `edges`, `ai_sessions`, `funnel_metrics`, `funnel_instances`

---

#### **nodes（漏斗节点表）**
**用途**: 存储漏斗中每个节点的详细信息和位置数据

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 节点主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一节点标识符 |
| funnelId | 所属漏斗 | UUID | FK, 非空 | - | 关联的漏斗ID |
| nodeType | 节点类型 | NodeType枚举 | 非空 | - | 节点在漏斗中的业务类型 |
| label | 节点标签 | VARCHAR(30) | 非空 | "新节点" | 节点的显示名称 |
| positionX | X坐标 | DECIMAL(10,2) | 非空 | - | 节点在画布中的X轴位置 |
| positionY | Y坐标 | DECIMAL(10,2) | 非空 | - | 节点在画布中的Y轴位置 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 节点创建时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 节点最后修改时间 |

**索引策略**:
- `funnelId` - 漏斗节点查询索引
- `nodeType` - 节点类型过滤索引
- `[positionX, positionY]` - 位置查询复合索引

**业务关系**:
- 多对一 → `funnels` (所属漏斗)
- 一对多 → `edges` (作为源节点), `edges` (作为目标节点), `node_data`, `node_metrics`

---

#### **edges（节点连接表）**
**用途**: 定义漏斗节点之间的连接关系，构建漏斗流向

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 连接主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一连接标识符 |
| funnelId | 所属漏斗 | UUID | FK, 非空 | - | 关联的漏斗ID |
| sourceNodeId | 源节点 | UUID | FK, 非空 | - | 连接起始节点的ID |
| targetNodeId | 目标节点 | UUID | FK, 非空 | - | 连接目标节点的ID |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 连接创建时间 |

**索引策略**:
- `funnelId` - 漏斗连接查询索引
- `sourceNodeId` - 源节点查询索引
- `targetNodeId` - 目标节点查询索引
- `[sourceNodeId, targetNodeId]` - 唯一性约束复合索引，防止重复连接

**业务关系**:
- 多对一 → `funnels` (所属漏斗), `nodes` (源节点), `nodes` (目标节点)

---

#### **funnel_templates（漏斗模板表）**
**用途**: 存储预定义的漏斗模板，支持快速创建和共享

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 模板主键 | CUID | PK, 非空 | cuid() | 模板唯一标识符 |
| name | 模板名称 | VARCHAR(100) | 非空 | - | 模板的显示名称 |
| description | 模板描述 | TEXT | 可空 | - | 模板用途和适用场景说明 |
| templateData | 模板数据 | JSON | 非空 | - | 包含节点和连接的完整模板结构 |
| isDefault | 默认模板 | BOOLEAN | 非空 | false | 标识是否为系统预置模板 |
| organizationId | 所属组织 | UUID | FK, 非空 | - | 创建该模板的组织 |
| createdBy | 创建人 | UUID | FK, 非空 | - | 创建该模板的用户 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 模板创建时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 模板最后修改时间 |

**索引策略**:
- `organizationId` - 组织模板查询索引
- `createdBy` - 创建者查询索引
- `isDefault` - 默认模板筛选索引
- `name` - 名称搜索索引
- `[organizationId, isDefault]` - 组织默认模板复合索引

**业务关系**:
- 多对一 → `organizations` (所属组织), `users` (创建者)

---

#### **funnel_instances（漏斗实例表）**
**用途**: 基于模板创建的具体漏斗运营实例

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 实例主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一实例标识符 |
| name | 实例名称 | VARCHAR(150) | 非空 | - | 实例的业务名称 |
| description | 实例描述 | TEXT | 可空 | - | 实例的用途和配置说明 |
| funnelTemplateId | 基础模板 | UUID | FK, 非空 | - | 基于的漏斗模板ID |
| userId | 创建用户 | UUID | FK, 非空 | - | 创建该实例的用户 |
| organizationId | 所属组织 | UUID | FK, 可空 | - | 实例所属的组织 |
| status | 实例状态 | FunnelInstanceStatus枚举 | 非空 | draft | 实例当前的运营状态 |
| periodStartDate | 分析开始日期 | DATE | 可空 | - | 数据分析的起始日期 |
| periodEndDate | 分析结束日期 | DATE | 可空 | - | 数据分析的结束日期 |
| instanceData | 实例配置 | JSON | 可空 | - | 实例特定的配置和参数 |
| tags | 分类标签 | String[] | 非空 | [] | 实例分类和搜索标签 |
| notes | 备注信息 | TEXT | 可空 | - | 实例运营的补充说明 |
| isActive | 激活状态 | BOOLEAN | 非空 | true | 实例是否处于激活状态 |
| completedAt | 完成时间 | TIMESTAMPTZ(6) | 可空 | - | 实例完成或结束的时间 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 实例创建时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 实例最后修改时间 |

**索引策略**:
- `funnelTemplateId` - 模板实例查询索引
- `userId` - 用户实例查询索引
- `organizationId` - 组织实例查询索引
- `status` - 状态过滤索引
- `isActive` - 活跃状态索引
- `tags` - 标签搜索索引
- `[periodStartDate, periodEndDate]` - 时间范围复合索引
- `[funnelTemplateId, status]` - 模板状态复合索引

**业务关系**:
- 多对一 → `funnels` (作为模板), `users` (创建者), `organizations` (所属组织)
- 一对多 → `funnel_instance_metrics`

---

### 3.3 数据分析统计表

#### **node_data（节点数据表）**
**用途**: 存储漏斗节点的业务运营数据，按周进行统计汇总

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 数据主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一数据记录标识符 |
| nodeId | 节点ID | UUID | FK, 非空 | - | 关联的漏斗节点 |
| weekStartDate | 周开始日期 | DATE | 非空 | - | 该周数据统计的起始日期 |
| entryCount | 进入用户数 | INTEGER | 非空 | 0 | 进入该节点的用户总数 |
| convertedCount | 转化用户数 | INTEGER | 非空 | 0 | 成功转化到下一节点的用户数 |
| conversionRate | 转化率 | DECIMAL(5,4) | 可空 | - | 转化率百分比 (0.0000-1.0000) |
| bounceCount | 跳出用户数 | INTEGER | 可空 | 0 | 在该节点跳出流程的用户数 |
| avgTimeSpent | 平均停留时间 | INTEGER | 可空 | - | 用户在该节点的平均停留时间(秒) |
| revenue | 节点收入 | DECIMAL(12,2) | 可空 | - | 该节点产生的收入金额 |
| cost | 节点成本 | DECIMAL(12,2) | 可空 | - | 该节点投入的成本金额 |
| notes | 数据备注 | TEXT | 可空 | - | 数据异常或特殊情况的说明 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 数据记录创建时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 数据最后更新时间 |

**索引策略**:
- `[nodeId, weekStartDate]` - 唯一性约束复合索引，确保每个节点每周一条记录
- `nodeId` - 节点查询索引
- `weekStartDate` - 时间查询索引
- `conversionRate` - 转化率排序索引
- `revenue` - 收入排序索引
- `[nodeId, weekStartDate, conversionRate]` - 节点时间转化率三维复合索引

**业务关系**:
- 多对一 → `nodes` (所属节点)

---

#### **funnel_metrics（漏斗指标表）**
**用途**: 存储整个漏斗的综合分析指标，支持周度和月度统计

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 指标主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一指标记录标识符 |
| funnelId | 漏斗ID | UUID | FK, 非空 | - | 关联的漏斗 |
| periodType | 统计周期 | MetricPeriodType枚举 | 非空 | - | 周度或月度统计类型 |
| periodStartDate | 周期开始 | DATE | 非空 | - | 统计周期的起始日期 |
| periodEndDate | 周期结束 | DATE | 非空 | - | 统计周期的结束日期 |
| totalEntries | 总进入量 | INTEGER | 非空 | 0 | 漏斗顶部的总流入用户数 |
| totalConversions | 总转化量 | INTEGER | 非空 | 0 | 漏斗底部的总转化用户数 |
| overallConversionRate | 整体转化率 | DECIMAL(5,4) | 可空 | - | 端到端的整体转化率 |
| totalRevenue | 总收入 | DECIMAL(12,2) | 可空 | - | 漏斗在该周期产生的总收入 |
| totalCost | 总成本 | DECIMAL(12,2) | 可空 | - | 漏斗在该周期的总投入成本 |
| roi | 投资回报率 | DECIMAL(8,4) | 可空 | - | ROI = (收入-成本)/成本 |
| avgTimeSpent | 平均流程时间 | INTEGER | 可空 | - | 用户走完整个漏斗的平均时间(秒) |
| bounceRate | 总体跳出率 | DECIMAL(5,4) | 可空 | - | 在漏斗中途放弃的用户比例 |
| notes | 指标备注 | TEXT | 可空 | - | 指标异常或特殊情况的说明 |
| customMetrics | 自定义指标 | JSON | 可空 | - | 扩展的业务特定指标数据 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 指标计算时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 指标最后更新时间 |

**索引策略**:
- `[funnelId, periodType, periodStartDate]` - 唯一性约束复合索引
- `funnelId` - 漏斗查询索引
- `periodType` - 周期类型索引
- `[periodStartDate, periodEndDate]` - 时间范围复合索引
- `overallConversionRate` - 转化率排序索引
- `totalRevenue` - 收入排序索引

**业务关系**:
- 多对一 → `funnels` (所属漏斗)

---

#### **node_metrics（节点指标表）**
**用途**: 存储单个节点的详细分析指标，包含广告指标和自定义指标

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 指标主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一指标记录标识符 |
| nodeId | 节点ID | UUID | FK, 非空 | - | 关联的漏斗节点 |
| periodType | 统计周期 | MetricPeriodType枚举 | 非空 | - | 周度或月度统计类型 |
| periodStartDate | 周期开始 | DATE | 非空 | - | 统计周期的起始日期 |
| periodEndDate | 周期结束 | DATE | 非空 | - | 统计周期的结束日期 |
| entryCount | 进入数量 | INTEGER | 非空 | 0 | 进入该节点的用户数 |
| exitCount | 退出数量 | INTEGER | 非空 | 0 | 离开该节点的用户数 |
| convertedCount | 转化数量 | INTEGER | 非空 | 0 | 成功转化的用户数 |
| conversionRate | 转化率 | DECIMAL(5,4) | 可空 | - | 节点转化率百分比 |
| bounceCount | 跳出数量 | INTEGER | 可空 | 0 | 在该节点跳出的用户数 |
| avgTimeSpent | 平均停留时间 | INTEGER | 可空 | - | 平均停留时间(秒) |
| revenue | 节点收入 | DECIMAL(12,2) | 可空 | - | 该节点产生的收入 |
| cost | 节点成本 | DECIMAL(12,2) | 可空 | - | 该节点的投入成本 |
| impressions | 广告展示次数 | INTEGER | 可空 | 0 | 广告或内容的展示次数 |
| clicks | 广告点击次数 | INTEGER | 可空 | 0 | 广告或链接的点击次数 |
| ctr | 点击率 | DECIMAL(5,4) | 可空 | - | 点击率 = 点击数/展示数 |
| cpc | 单次点击成本 | DECIMAL(8,4) | 可空 | - | 每次点击的平均成本 |
| cpm | 千次展示成本 | DECIMAL(8,4) | 可空 | - | 每千次展示的成本 |
| notes | 指标备注 | TEXT | 可空 | - | 指标异常或特殊情况说明 |
| customMetrics | 自定义指标 | JSON | 可空 | - | 业务特定的扩展指标数据 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 指标计算时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 指标最后更新时间 |

**索引策略**:
- `[nodeId, periodType, periodStartDate]` - 唯一性约束复合索引
- `nodeId` - 节点查询索引
- `periodType` - 周期类型索引
- `[periodStartDate, periodEndDate]` - 时间范围复合索引
- `conversionRate` - 转化率排序索引
- `revenue` - 收入排序索引

**业务关系**:
- 多对一 → `nodes` (所属节点)

---

#### **funnel_instance_metrics（漏斗实例指标表）**
**用途**: 存储漏斗实例的运营指标数据

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 指标主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一指标记录标识符 |
| instanceId | 实例ID | UUID | FK, 非空 | - | 关联的漏斗实例 |
| periodType | 统计周期 | MetricPeriodType枚举 | 非空 | - | 周度或月度统计类型 |
| periodStartDate | 周期开始 | DATE | 非空 | - | 统计周期的起始日期 |
| periodEndDate | 周期结束 | DATE | 非空 | - | 统计周期的结束日期 |
| totalEntries | 总进入量 | INTEGER | 非空 | 0 | 实例漏斗的总流入用户数 |
| totalConversions | 总转化量 | INTEGER | 非空 | 0 | 实例漏斗的总转化用户数 |
| overallConversionRate | 整体转化率 | DECIMAL(5,4) | 可空 | - | 实例的端到端转化率 |
| totalRevenue | 总收入 | DECIMAL(12,2) | 可空 | - | 实例产生的总收入 |
| totalCost | 总成本 | DECIMAL(12,2) | 可空 | - | 实例的总投入成本 |
| roi | 投资回报率 | DECIMAL(8,4) | 可空 | - | 实例的ROI指标 |
| avgTimeSpent | 平均流程时间 | INTEGER | 可空 | - | 实例流程的平均完成时间 |
| bounceRate | 跳出率 | DECIMAL(5,4) | 可空 | - | 实例的用户跳出比例 |
| notes | 指标备注 | TEXT | 可空 | - | 实例指标的补充说明 |
| customMetrics | 自定义指标 | JSON | 可空 | - | 实例特定的扩展指标 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 指标计算时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 指标最后更新时间 |

**索引策略**:
- `[instanceId, periodType, periodStartDate]` - 唯一性约束复合索引
- `instanceId` - 实例查询索引
- `periodType` - 周期类型索引
- `[periodStartDate, periodEndDate]` - 时间范围复合索引
- `overallConversionRate` - 转化率排序索引
- `totalRevenue` - 收入排序索引

**业务关系**:
- 多对一 → `funnel_instances` (所属实例)

---

#### **metric_datasets（指标数据集表）**
**用途**: 配置和管理外部数据源的连接信息

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 数据集主键 | CUID | PK, 非空 | cuid() | 数据集唯一标识符 |
| name | 数据集名称 | VARCHAR(100) | 非空 | - | 数据集的显示名称 |
| datasetType | 数据集类型 | VARCHAR(50) | 非空 | - | 数据集分类 (如: analytics, crm, ads) |
| dataSource | 数据源标识 | VARCHAR(50) | 非空 | - | 数据源类型 (如: google_analytics, salesforce) |
| config | 连接配置 | JSON | 非空 | - | 数据源连接参数和认证信息 |
| organizationId | 所属组织 | UUID | FK, 非空 | - | 创建该数据集的组织 |
| createdBy | 创建人 | UUID | FK, 非空 | - | 创建该数据集的用户 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 数据集创建时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 配置最后修改时间 |

**索引策略**:
- `organizationId` - 组织数据集查询索引
- `createdBy` - 创建者查询索引
- `datasetType` - 类型筛选索引
- `dataSource` - 数据源筛选索引
- `[organizationId, datasetType]` - 组织类型复合索引

**业务关系**:
- 多对一 → `organizations` (所属组织), `users` (创建者)

---

### 3.4 AI智能助手表

#### **ai_sessions（AI会话表）**
**用途**: 管理用户与AI助手的对话会话

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 会话主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一会话标识符 |
| userId | 用户ID | UUID | FK, 非空 | - | 发起会话的用户 |
| funnelId | 关联漏斗 | UUID | FK, 可空 | - | 会话关联的漏斗(可选) |
| sessionContext | 会话上下文 | SessionContext枚举 | 可空 | - | 会话的业务场景类型 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 会话开始时间 |
| endedAt | 结束时间 | TIMESTAMPTZ(6) | 可空 | - | 会话结束时间 |

**索引策略**:
- `userId` - 用户会话查询索引
- `funnelId` - 漏斗相关会话索引
- `sessionContext` - 会话类型索引
- `createdAt` - 时间排序索引

**业务关系**:
- 多对一 → `users` (会话用户), `funnels` (关联漏斗)
- 一对多 → `ai_messages`, `user_ai_usage`

---

#### **ai_messages（AI消息表）**
**用途**: 存储AI会话中的具体消息内容

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 消息主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一消息标识符 |
| sessionId | 所属会话 | UUID | FK, 非空 | - | 关联的AI会话 |
| role | 消息角色 | MessageRole枚举 | 非空 | - | 消息发送方 (用户/助手) |
| content | 消息内容 | TEXT | 非空 | - | 消息的文本内容 |
| createdAt | 发送时间 | TIMESTAMPTZ(6) | 非空 | now() | 消息发送时间 |

**索引策略**:
- `sessionId` - 会话消息查询索引
- `role` - 角色筛选索引
- `createdAt` - 时间排序索引

**业务关系**:
- 多对一 → `ai_sessions` (所属会话)

---

#### **user_ai_usage（用户AI使用记录表）**
**用途**: 记录和统计用户的AI功能使用情况

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 记录主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一使用记录标识符 |
| userId | 用户ID | UUID | FK, 非空 | - | 使用AI功能的用户 |
| sessionId | 会话ID | UUID | FK, 可空 | - | 关联的AI会话(可选) |
| usageType | 使用类型 | AiUsageType枚举 | 非空 | - | AI功能类型 |
| requestCount | 请求次数 | INTEGER | 非空 | 1 | 单次记录的请求数量 |
| tokenCount | Token消耗 | INTEGER | 可空 | - | 消耗的AI token数量 |
| cost | 产生费用 | DECIMAL(10,4) | 可空 | - | 该次使用产生的费用 |
| usageDate | 使用日期 | DATE | 非空 | - | 使用日期(用于配额统计) |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 记录创建时间 |

**索引策略**:
- `userId` - 用户使用记录索引
- `sessionId` - 会话使用记录索引
- `usageType` - 使用类型统计索引
- `usageDate` - 使用日期统计索引
- `[userId, usageDate]` - 用户日期复合索引
- `[usageDate, usageType]` - 日期类型复合索引

**业务关系**:
- 多对一 → `users` (使用用户), `ai_sessions` (关联会话)

---

#### **user_ai_limits（用户AI使用限制表）**
**用途**: 管理每个用户的AI功能使用配额和重置周期

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 限制主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一限制记录标识符 |
| userId | 用户ID | UUID | FK, UNIQUE, 非空 | - | 关联用户(一对一关系) |
| dailyLimit | 每日限制 | INTEGER | 非空 | 100 | 每日AI使用次数上限 |
| monthlyLimit | 每月限制 | INTEGER | 非空 | 3000 | 每月AI使用次数上限 |
| currentDaily | 当日已用 | INTEGER | 非空 | 0 | 当日已使用次数统计 |
| currentMonthly | 当月已用 | INTEGER | 非空 | 0 | 当月已使用次数统计 |
| isActive | 启用状态 | BOOLEAN | 非空 | true | 是否启用AI使用限制 |
| lastResetDaily | 日重置时间 | DATE | 非空 | now() | 上次日限制重置时间 |
| lastResetMonthly | 月重置时间 | DATE | 非空 | now() | 上次月限制重置时间 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 限制记录创建时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 自动更新 | - | 最后一次更新时间 |

**索引策略**:
- `userId` - 唯一索引，确保一对一关系
- `isActive` - 状态筛选索引，快速查询启用状态
- `lastResetDaily` - 日重置时间索引，支持重置计算
- `lastResetMonthly` - 月重置时间索引，支持重置计算

**业务关系**:
- 一对一 → `users` (用户AI限制)

---

### 3.5 基准数据和规则表

#### **benchmark_data（基准数据表）**
**用途**: 存储行业基准数据用于对比分析

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 基准主键 | CUID | PK, 非空 | cuid() | 基准数据唯一标识符 |
| industry | 行业分类 | VARCHAR(100) | 非空 | - | 适用的行业类别 |
| metricType | 指标类型 | VARCHAR(100) | 非空 | - | 指标大类 (如: conversion, engagement) |
| metricName | 指标名称 | VARCHAR(100) | 非空 | - | 具体指标名称 |
| value | 基准数值 | DECIMAL(12,6) | 非空 | - | 基准数据的数值 |
| percentile | 百分位数 | INTEGER | 非空 | - | 该数值所处的百分位 (如: 50, 75, 90) |
| sampleSize | 样本规模 | INTEGER | 非空 | - | 统计样本的数量 |
| periodStart | 统计开始 | DATE | 非空 | - | 基准数据的统计起始日期 |
| periodEnd | 统计结束 | DATE | 非空 | - | 基准数据的统计结束日期 |
| organizationId | 所属组织 | UUID | FK, 非空 | - | 创建该基准数据的组织 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 基准数据创建时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 基准数据最后更新时间 |

**索引策略**:
- `[industry, metricType, metricName, percentile, periodStart, periodEnd]` - 唯一性约束复合索引
- `organizationId` - 组织查询索引
- `industry` - 行业筛选索引
- `metricType` - 指标类型索引
- `metricName` - 指标名称索引
- `percentile` - 百分位筛选索引
- `[periodStart, periodEnd]` - 时间范围复合索引
- `[industry, metricType, metricName]` - 指标查询三维复合索引

**业务关系**:
- 多对一 → `organizations` (所属组织)

---

#### **advice_rules（建议规则表）**
**用途**: 定义AI智能建议生成的业务规则

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 规则主键 | CUID | PK, 非空 | cuid() | 建议规则唯一标识符 |
| name | 规则名称 | VARCHAR(100) | 非空 | - | 规则的显示名称 |
| description | 规则描述 | TEXT | 可空 | - | 规则用途和逻辑的详细说明 |
| ruleType | 规则类型 | VARCHAR(50) | 非空 | - | 规则分类 (如: performance, conversion, cost) |
| conditions | 触发条件 | JSON | 非空 | - | 规则触发的条件配置 |
| advice | 建议内容 | JSON | 非空 | - | 匹配条件时生成的建议内容 |
| priority | 优先级 | INTEGER | 非空 | 1 | 规则执行优先级 (数字越小优先级越高) |
| isActive | 规则状态 | BOOLEAN | 非空 | true | 规则是否启用 |
| organizationId | 所属组织 | UUID | FK, 非空 | - | 创建该规则的组织 |
| createdBy | 创建人 | UUID | FK, 非空 | - | 创建该规则的用户 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 规则创建时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 规则最后修改时间 |

**索引策略**:
- `organizationId` - 组织规则查询索引
- `createdBy` - 创建者查询索引
- `ruleType` - 规则类型筛选索引
- `priority` - 优先级排序索引
- `isActive` - 活跃状态索引
- `[organizationId, ruleType, isActive]` - 组织类型状态三维复合索引

**业务关系**:
- 多对一 → `organizations` (所属组织), `users` (创建者)

---

### 3.6 系统管理和审计表

#### **admin_users（管理员用户表）**
**用途**: 独立的系统管理员账户体系

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 管理员主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一管理员标识符 |
| username | 管理员用户名 | VARCHAR(50) | UNIQUE, 非空 | - | 管理员登录用户名 |
| email | 管理员邮箱 | VARCHAR(255) | UNIQUE, 非空 | - | 管理员邮箱地址 |
| passwordHash | 密码哈希 | VARCHAR(255) | 非空 | - | 管理员密码的加密哈希值 |
| firstName | 管理员名字 | VARCHAR(50) | 可空 | - | 管理员的名字 |
| lastName | 管理员姓氏 | VARCHAR(50) | 可空 | - | 管理员的姓氏 |
| role | 管理员角色 | AdminRole枚举 | 非空 | admin | 管理员权限级别 |
| isActive | 账户状态 | BOOLEAN | 非空 | true | 管理员账户是否激活 |
| lastLoginAt | 最后登录 | TIMESTAMPTZ(6) | 可空 | - | 管理员最后登录时间 |
| createdAt | 创建时间 | TIMESTAMPTZ(6) | 非空 | now() | 管理员账户创建时间 |
| updatedAt | 更新时间 | TIMESTAMPTZ(6) | 非空 | 自动更新 | 账户信息最后更新时间 |

**索引策略**:
- `username` - 唯一索引,登录查询优化
- `email` - 唯一索引,邮箱登录支持
- `role` - 角色筛选索引
- `isActive` - 状态筛选索引

**业务关系**:
- 一对多 → `admin_operation_logs` (操作日志)

---

#### **admin_operation_logs（管理员操作日志表）**
**用途**: 记录管理员的所有操作行为用于审计

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 日志主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一日志记录标识符 |
| adminId | 管理员ID | UUID | FK, 非空 | - | 执行操作的管理员 |
| targetType | 目标类型 | VARCHAR(50) | 非空 | - | 操作对象的类型 (如: user, organization) |
| targetId | 目标ID | UUID | 可空 | - | 操作对象的具体ID |
| operation | 操作内容 | VARCHAR(100) | 非空 | - | 执行的具体操作 (如: create, update, delete) |
| oldValues | 操作前数据 | JSON | 可空 | - | 操作前的数据快照 |
| newValues | 操作后数据 | JSON | 可空 | - | 操作后的数据快照 |
| result | 操作结果 | VARCHAR(20) | 可空 | - | 操作执行结果 (success, failed, etc) |
| ipAddress | IP地址 | VARCHAR(45) | 可空 | - | 执行操作的IP地址 |
| userAgent | 用户代理 | TEXT | 可空 | - | 浏览器和设备信息 |
| createdAt | 操作时间 | TIMESTAMPTZ(6) | 非空 | now() | 操作执行的精确时间 |

**索引策略**:
- `adminId` - 管理员操作查询索引
- `targetType` - 目标类型筛选索引
- `targetId` - 目标对象查询索引
- `operation` - 操作类型统计索引
- `result` - 操作结果筛选索引
- `createdAt` - 时间排序索引

**业务关系**:
- 多对一 → `admin_users` (执行管理员)

---

#### **audit_log（审计日志表）**
**用途**: 系统级别的数据变更审计追踪

| 字段名 | 中文含义 | 数据类型 | 约束条件 | 默认值 | 详细说明 |
|--------|----------|----------|-----------|--------|----------|
| id | 审计主键 | UUID | PK, 非空 | gen_random_uuid() | 全局唯一审计记录标识符 |
| tableName | 数据表名 | VARCHAR(50) | 非空 | - | 发生变更的数据表名称 |
| operation | 操作类型 | Operation枚举 | 非空 | - | 数据库操作类型 (INSERT/UPDATE/DELETE) |
| oldValues | 变更前数据 | JSON | 可空 | - | 变更前的完整数据快照 |
| newValues | 变更后数据 | JSON | 可空 | - | 变更后的完整数据快照 |
| userId | 操作用户 | UUID | 可空 | - | 触发变更的用户ID(可选) |
| timestamp | 变更时间 | TIMESTAMPTZ(6) | 非空 | now() | 数据变更的精确时间戳 |

**索引策略**:
- `tableName` - 表名查询索引
- `operation` - 操作类型统计索引
- `userId` - 用户操作查询索引
- `timestamp` - 时间排序索引

**业务关系**:
- 无外键关系 (独立的审计表)

---

## 4. 表关系分析

### 4.1 一对一关系 (1:1)
```
Organization ←→ OrgUsageLimit     (组织 ↔ 资源使用限制)
User ←→ UserAiLimit               (用户 ↔ AI使用限制)
```

### 4.2 一对多关系 (1:N)

#### 组织架构层级关系
```
Industry (行业)
  ↓ 1:N
Organization (组织)
  ↓ 1:N  
User (用户)
```

#### 漏斗设计体系关系
```
Funnel (漏斗模板)
  ├── 1:N → Node (漏斗节点)
  ├── 1:N → Edge (节点连接)
  ├── 1:N → FunnelInstance (漏斗实例)
  └── 1:N → FunnelMetrics (漏斗指标)

Node (漏斗节点)
  ├── 1:N → NodeData (节点数据)
  └── 1:N → NodeMetrics (节点指标)

FunnelInstance (漏斗实例)
  └── 1:N → FunnelInstanceMetrics (实例指标)
```

#### AI智能助手体系关系
```
User (用户)
  ↓ 1:N
AiSession (AI会话)
  ├── 1:N → AiMessage (会话消息)
  └── 1:N → UserAiUsage (使用记录)
```

#### 管理和审计体系关系
```
Organization (组织)
  ├── 1:N → MetricDataset (数据集)
  ├── 1:N → BenchmarkData (基准数据)
  └── 1:N → AdviceRule (建议规则)

AdminUser (管理员)
  └── 1:N → AdminOperationLog (操作日志)
```

### 4.3 多对多关系 (N:M)
```
Node ←→ Node (通过Edge表实现)
  源节点ID ← Edge → 目标节点ID
```

### 4.4 级联删除策略
- **用户删除**: 级联删除用户创建的所有漏斗、模板、实例、AI会话等
- **组织删除**: 级联删除组织的资源限制、模板、数据集等
- **漏斗删除**: 级联删除漏斗的所有节点、连接、指标数据
- **节点删除**: 级联删除节点的数据记录和相关连接
- **会话删除**: 级联删除会话的所有消息记录

---

## 5. ER图 (实体关系图)

### 5.1 核心业务关系总览

```
                    ┌─────────────────┐
                    │    Industry     │
                    │   (行业分类)     │
                    └─────────┬───────┘
                             │ 1:N
                    ┌─────────▼───────┐
                    │  Organization   │◄──────────┐
                    │   (组织机构)     │           │ 1:1
                    └─────┬───────────┘           │
                         │ 1:N                   │
                    ┌────▼────┐                  │
                    │  User   │                  │
                    │ (用户)   │                  │
                    └────┬────┘                  │
                         │ 1:N                   │
        ┌────────────────▼───────────────────┐   │
        │             Funnel                │   │
        │          (漏斗设计)                │   │
        └─────┬─────────────────┬──────────┘   │
              │ 1:N             │ 1:N           │
        ┌─────▼────┐      ┌─────▼────────┐     │
        │   Node   │      │FunnelInstance│     │
        │  (节点)   │      │ (漏斗实例)    │     │
        └─────┬────┘      └─────┬────────┘     │
              │ 1:N             │ 1:N           │
         ┌────▼──────┐    ┌─────▼────────────┐ │
         │ NodeData  │    │FunnelInstance    │ │
         │(节点数据)  │    │   Metrics       │ │
         └───────────┘    │  (实例指标)      │ │
                          └──────────────────┘ │
                                               │
                    ┌─────────────────────────────┘
                    │
               ┌────▼──────┐
               │OrgUsage   │
               │ Limit     │
               │(使用限制) │
               └───────────┘
```

### 5.2 AI智能助手模块关系图

```
         ┌─────────────┐
         │    User     │
         │   (用户)     │
         └──────┬──────┘
                │ 1:N
         ┌──────▼──────┐
         │  AiSession  │
         │  (AI会话)    │
         └──┬───────┬──┘
            │ 1:N   │ 1:N
    ┌───────▼──┐    │
    │AiMessage │    │
    │ (AI消息) │    │
    └──────────┘    │
                    │
            ┌───────▼──────┐
            │ UserAiUsage  │
            │(AI使用记录)   │
            └──────────────┘

         ┌─────────────┐
         │    User     │
         │   (用户)     │
         └──────┬──────┘
                │ 1:1
         ┌──────▼──────┐
         │UserAiLimit  │
         │(AI使用限制)  │
         └─────────────┘
```

### 5.3 数据分析模块关系图

```
         ┌─────────────┐
         │   Funnel    │
         │  (漏斗)      │
         └──────┬──────┘
                │ 1:N
         ┌──────▼──────┐
         │    Node     │
         │   (节点)     │
         └──┬───────┬──┘
            │ 1:N   │ 1:N
    ┌───────▼──┐ ┌──▼────────┐
    │ NodeData │ │NodeMetrics│
    │(节点数据)│ │ (节点指标) │
    └──────────┘ └───────────┘

         ┌─────────────┐
         │   Funnel    │
         │  (漏斗)      │
         └──────┬──────┘
                │ 1:N
         ┌──────▼──────┐
         │FunnelMetrics│
         │ (漏斗指标)   │
         └─────────────┘
```

### 5.4 管理审计模块关系图

```
         ┌──────────────┐
         │  AdminUser   │
         │  (管理员)     │
         └──────┬───────┘
                │ 1:N
    ┌───────────▼──────────────┐
    │   AdminOperationLog     │
    │    (管理员操作日志)       │
    └─────────────────────────┘

         ┌──────────────┐
         │     User     │
         │    (用户)     │
         └──────┬───────┘
                │ 1:N (可选)
         ┌──────▼───────┐
         │   AuditLog   │
         │  (审计日志)   │
         └──────────────┘
```

### 5.5 完整外键关系映射表

| 外键字段 | 源表 | 目标表.字段 | 关系类型 | 删除策略 |
|----------|------|-------------|----------|----------|
| industryId | organizations | industries.id | N:1 | SET NULL |
| organizationId | users | organizations.id | N:1 | SET NULL |
| organizationId | funnels | organizations.id | N:1 | CASCADE |
| userId | funnels | users.id | N:1 | CASCADE |
| funnelId | nodes | funnels.id | N:1 | CASCADE |
| funnelId | edges | funnels.id | N:1 | CASCADE |
| sourceNodeId | edges | nodes.id | N:1 | CASCADE |
| targetNodeId | edges | nodes.id | N:1 | CASCADE |
| nodeId | node_data | nodes.id | N:1 | CASCADE |
| nodeId | node_metrics | nodes.id | N:1 | CASCADE |
| funnelId | funnel_metrics | funnels.id | N:1 | CASCADE |
| funnelTemplateId | funnel_instances | funnels.id | N:1 | CASCADE |
| userId | funnel_instances | users.id | N:1 | CASCADE |
| instanceId | funnel_instance_metrics | funnel_instances.id | N:1 | CASCADE |
| userId | ai_sessions | users.id | N:1 | CASCADE |
| sessionId | ai_messages | ai_sessions.id | N:1 | CASCADE |
| userId | user_ai_limits | users.id | 1:1 | CASCADE |
| userId | user_ai_usage | users.id | N:1 | CASCADE |
| organizationId | org_usage_limits | organizations.id | 1:1 | CASCADE |
| adminUserId | admin_operation_logs | admin_users.id | N:1 | CASCADE |

---

## 6. 枚举类型定义

### 6.1 用户权限相关枚举

#### **UserRole（用户角色）**
```typescript
enum UserRole {
  owner   = "owner"    // 组织拥有者 - 最高权限
  admin   = "admin"    // 组织管理员 - 管理权限
  member  = "member"   // 普通成员 - 基础权限
}
```

#### **AdminRole（管理员角色）**
```typescript
enum AdminRole {
  super_admin = "super_admin"  // 超级管理员 - 系统级权限
  admin       = "admin"        // 普通管理员 - 管理级权限
}
```

### 6.2 业务配置相关枚举

#### **CompanySize（公司规模）**
```typescript
enum CompanySize {
  SIZE_1_10   = "SIZE_1_10"    // 1-10人小微企业
  SIZE_11_30  = "SIZE_11_30"   // 11-30人小型企业
  SIZE_31_100 = "SIZE_31_100"  // 31-100人中小型企业
}
```

#### **SalesModel（销售模式）**
```typescript
enum SalesModel {
  TO_B = "TO_B"  // B2B业务模式
  TO_C = "TO_C"  // B2C业务模式
}
```

### 6.3 漏斗分析相关枚举

#### **FunnelStatus（漏斗状态）**
```typescript
enum FunnelStatus {
  active    = "active"     // 活跃使用中
  archived  = "archived"   // 已归档备用
  template  = "template"   // 作为模板使用
}
```

#### **DataPeriod（数据统计周期）**
```typescript
enum DataPeriod {
  DAILY   = "DAILY"    // 按日统计
  WEEKLY  = "WEEKLY"   // 按周统计  
  MONTHLY = "MONTHLY"  // 按月统计
}
```

#### **NodeType（漏斗节点类型）**
```typescript
enum NodeType {
  awareness   = "awareness"    // 认知阶段节点
  acquisition = "acquisition"  // 获取阶段节点
  activation  = "activation"   // 激活阶段节点
  revenue     = "revenue"      // 收入阶段节点
  retention   = "retention"    // 留存阶段节点
}
```

#### **MetricPeriodType（指标周期类型）**
```typescript
enum MetricPeriodType {
  weekly  = "weekly"   // 周度指标统计
  monthly = "monthly"  // 月度指标统计
}
```

#### **FunnelInstanceStatus（漏斗实例状态）**
```typescript
enum FunnelInstanceStatus {
  draft       = "draft"        // 草稿状态
  active      = "active"       // 活跃运行
  in_progress = "in_progress"  // 进行中
  completed   = "completed"    // 已完成
  paused      = "paused"       // 已暂停
  archived    = "archived"     // 已归档
}
```

### 6.4 AI功能相关枚举

#### **SessionContext（AI会话上下文）**
```typescript
enum SessionContext {
  invitation         = "invitation"          // 邀请函生成场景
  objection_handling = "objection_handling"  // 异议处理场景
  general           = "general"              // 通用对话场景
}
```

#### **MessageRole（消息角色）**
```typescript
enum MessageRole {
  user      = "user"       // 用户发送的消息
  assistant = "assistant"  // AI助手回复的消息
}
```

#### **AiUsageType（AI使用类型）**
```typescript
enum AiUsageType {
  chat           = "chat"           // 对话聊天功能
  analysis       = "analysis"       // 数据分析功能
  recommendation = "recommendation" // 智能推荐功能
  general        = "general"        // 通用AI功能
}
```

### 6.5 系统审计相关枚举

#### **Operation（数据库操作类型）**
```typescript
enum Operation {
  INSERT = "INSERT"  // 数据插入操作
  UPDATE = "UPDATE"  // 数据更新操作
  DELETE = "DELETE"  // 数据删除操作
}
```

---

## 7. 业务逻辑关系说明

### 7.1 多租户组织架构
```
行业标准分类 → 组织信息管理 → 用户权限体系
     ↓              ↓              ↓
  Industry    Organization    User + Role
  (标准化)     (个性化)        (权限控制)
```

**核心逻辑**:
- 行业分类提供标准化的业务分类，支持基准对比
- 组织信息存储企业个性化配置（规模、地区、模式）
- 用户角色实现三级权限控制（owner > admin > member）
- 资源配额根据订阅计划动态限制使用量

### 7.2 漏斗设计和实例化流程
```
模板创建 → 漏斗设计 → 节点连接 → 实例化部署 → 数据采集
    ↓          ↓          ↓          ↓          ↓
Template   Funnel     Node+Edge   Instance   Metrics
(可复用)   (设计)     (结构)      (运营)     (分析)
```

**核心逻辑**:
- 模板系统支持快速创建和组织内共享
- 可视化设计器通过节点和连接构建漏斗结构
- 支持5种标准节点类型，覆盖完整客户旅程
- 实例化实现设计与运营分离，支持一对多部署
- 多维度数据采集支持实时分析和历史对比

### 7.3 AI智能助手体系
```
会话管理 → 消息存储 → 使用统计 → 配额控制 → 成本追踪
    ↓          ↓          ↓          ↓          ↓
AiSession   AiMessage   AiUsage    AiLimit    Cost
(上下文)    (内容)      (统计)     (限制)     (成本)
```

**核心逻辑**:
- 上下文感知的会话管理，支持漏斗关联对话
- 完整的消息历史存储，支持对话延续
- 精确的使用量统计，包含token和成本追踪  
- 灵活的配额管理，默认每日100次/月3000次
- 支持多种AI功能类型的差异化计费

### 7.4 数据分析和基准对比
```
原始数据 → 节点指标 → 漏斗指标 → 基准对比 → 智能建议
    ↓          ↓          ↓          ↓          ↓
NodeData   NodeMetrics FunnelMetrics Benchmark  Advice
(周度)      (详细)      (综合)       (行业)     (智能)
```

**核心逻辑**:
- 按周采集原始业务数据，确保数据时效性
- 多维度指标计算，包含转化、收入、成本、时间等
- 漏斗整体指标聚合，提供端到端分析视角
- 行业基准数据对比，识别优化机会
- 基于规则引擎的智能建议生成

### 7.5 系统管理和审计追踪
```
管理员权限 → 操作执行 → 行为记录 → 数据变更 → 审计分析
     ↓          ↓          ↓          ↓          ↓
AdminUser   Operation   OpLog      AuditLog   Analysis
(权限)      (行为)      (操作)     (变更)     (分析)
```

**核心逻辑**:
- 独立的管理员账户体系，与业务用户隔离
- 完整的操作行为记录，包含IP和设备信息
- 自动化的数据变更追踪，支持变更前后对比
- 多维度审计分析，支持合规和安全要求

---

## 8. 重要配置和限制

### 8.1 系统默认配置

#### **AI使用限制 (硬编码配置)**
```typescript
// 位置: backend/src/services/AiUsageService.ts
const DEFAULT_AI_LIMITS = {
  dailyLimit: 100,     // 每日100次请求限制
  monthlyLimit: 3000,  // 每月3000次请求限制
  isActive: true       // 默认启用限制
}
```

#### **组织资源限制 (默认配额)**
```typescript
// 位置: backend/prisma/schema.prisma
const DEFAULT_ORG_LIMITS = {
  maxFunnels: 10,      // 最大漏斗数量
  maxTemplates: 5,     // 最大模板数量  
  maxInstances: 50,    // 最大实例数量
  maxUsers: 5,         // 最大用户数量
  planType: "free"     // 默认免费计划
}
```

### 8.2 性能优化配置

#### **核心索引策略**
- **查询热点索引**: 用户ID、组织ID、时间字段
- **唯一性约束索引**: 用户名、邮箱、组织slug
- **复合查询索引**: [userId, status]、[orgId, type]
- **时间范围索引**: 支持高效的时间范围查询
- **全文搜索索引**: 名称、标签、描述字段

#### **数据分区策略**
- **时间分区**: 大表按月分区存储
- **组织分区**: 多租户数据物理隔离选项
- **归档策略**: 超过2年的历史数据自动归档

### 8.3 安全和合规配置

#### **数据加密**
- **传输加密**: 所有API通信使用HTTPS
- **存储加密**: 敏感字段使用AES-256加密
- **密码安全**: bcrypt哈希 + 盐值加密

#### **审计要求**
- **操作追踪**: 所有管理员操作100%记录
- **数据变更**: 关键表变更自动审计
- **访问日志**: IP、设备、时间完整记录
- **保留期限**: 审计日志保留3年

### 8.4 扩展性设计

#### **水平扩展支持**
- **读写分离**: 主从数据库架构支持
- **分片策略**: 基于组织ID的数据分片
- **缓存机制**: Redis缓存热点数据

#### **功能扩展点**
- **自定义指标**: JSON字段支持业务扩展
- **插件架构**: 预留第三方集成接口
- **多语言**: 国际化字段设计就绪

---

## 总结

Pathfinder数据库设计采用现代化的架构模式，具备以下核心特性：

✅ **完整的多租户支持** - 基于组织的数据隔离和权限控制  
✅ **灵活的漏斗设计** - 可视化编辑器 + 模板系统 + 实例化部署  
✅ **智能AI助手** - 上下文感知对话 + 使用配额管理 + 成本追踪  
✅ **全面数据分析** - 多维度指标 + 行业基准 + 智能建议  
✅ **完善审计体系** - 操作日志 + 数据变更追踪 + 合规支持  
✅ **高性能优化** - 120+索引 + 查询优化 + 扩展性设计  

该设计支撑了一个功能完整、性能优异、安全可靠的企业级漏斗分析SaaS平台。

---

*文档版本: 2.0*  
*数据库版本: PostgreSQL 15+*  
*ORM框架: Prisma 5.x*  
*最后更新: 2024年*