# 数据库表字段与用户动作映射详解

## 目录
1. [用户与组织管理](#用户与组织管理)
2. [漏斗管理系统](#漏斗管理系统)
3. [指标与分析](#指标与分析)
4. [AI辅助系统](#ai辅助系统)
5. [模板与配置](#模板与配置)
6. [使用限制与管理](#使用限制与管理)
7. [审计日志](#审计日志)

---

## 用户与组织管理

### 1. industries 表（行业信息）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 创建行业时 | 行业唯一标识 |
| code | VARCHAR(50) | 管理员设置 | 添加新行业 | 行业代码（如：SAAS, RETAIL） |
| name | VARCHAR(100) | 管理员输入 | 添加新行业 | 行业中文名称 |
| nameEn | VARCHAR(100) | 管理员输入 | 添加新行业 | 行业英文名称 |
| description | TEXT | 管理员输入 | 添加行业描述 | 行业详细说明 |
| isActive | BOOLEAN | 管理员切换 | 启用/禁用行业 | 控制行业选项是否可见 |
| sortOrder | INTEGER | 管理员设置 | 调整显示顺序 | 行业列表排序权重 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间戳 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 最后更新时间 |

### 2. organizations 表（组织/公司）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 创建组织时 | 组织唯一标识 |
| name | VARCHAR(100) | 用户输入 | 注册/设置公司名称 | 公司/组织名称 |
| slug | VARCHAR(50) | 系统生成/用户修改 | 创建组织 | URL友好的组织标识 |
| description | TEXT | 用户输入 | 编辑组织信息 | 组织简介 |
| industryId | UUID | 用户选择 | 选择所属行业 | 关联行业类型 |
| companySize | ENUM | 用户选择 | 选择公司规模 | 1-10人/11-30人/31-100人等 |
| location | VARCHAR(100) | 用户输入 | 填写公司地址 | 公司所在地 |
| salesModel | ENUM | 用户选择 | 选择销售模式 | TO_B/TO_C |
| planType | VARCHAR(20) | 系统设置/用户升级 | 选择套餐 | free/basic/pro/enterprise |
| isActive | BOOLEAN | 管理员操作 | 激活/停用组织 | 组织账户状态 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |

### 3. users 表（用户账户）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 注册时 | 用户唯一标识 |
| username | VARCHAR(50) | 用户输入 | 注册/修改用户名 | 登录用户名 |
| email | VARCHAR(255) | 用户输入 | 注册/修改邮箱 | 用户邮箱 |
| phone | VARCHAR(20) | 用户输入 | 绑定手机号 | 手机号码 |
| passwordHash | VARCHAR(255) | 用户设置密码 | 注册/修改密码 | 加密后的密码 |
| firstName | VARCHAR(50) | 用户输入 | 完善个人信息 | 名 |
| lastName | VARCHAR(50) | 用户输入 | 完善个人信息 | 姓 |
| avatar | VARCHAR(500) | 用户上传 | 上传头像 | 头像URL |
| createdAt | TIMESTAMPTZ | 系统记录 | 注册时 | 注册时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改信息时 | 更新时间 |
| lastLoginAt | TIMESTAMPTZ | 系统记录 | 登录时 | 最后登录时间 |
| isActive | BOOLEAN | 管理员操作 | 激活/禁用账户 | 账户状态 |
| isEmailVerified | BOOLEAN | 用户验证邮箱 | 点击验证链接 | 邮箱验证状态 |
| organizationId | UUID | 用户加入组织 | 接受邀请/创建组织 | 所属组织 |
| role | ENUM | 管理员分配 | 设置用户权限 | owner/admin/member |

---

## 漏斗管理系统

### 4. funnels 表（漏斗模板/结构）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 创建漏斗时 | 漏斗唯一标识 |
| userId | UUID | 系统记录 | 创建漏斗 | 创建者ID |
| name | VARCHAR(100) | 用户输入 | 命名漏斗 | 漏斗名称 |
| description | TEXT | 用户输入 | 添加描述 | 漏斗说明 |
| canvasData | JSON | 用户拖拽/编辑 | 设计漏斗结构 | 画布数据（节点位置等） |
| status | ENUM | 用户操作 | 激活/归档漏斗 | active/archived/template |
| isTemplate | BOOLEAN | 用户设置 | 保存为模板 | 是否为模板 |
| dataPeriod | ENUM | 用户选择 | 设置数据周期 | DAILY/WEEKLY/MONTHLY |
| tags | String[] | 用户添加 | 添加标签 | 漏斗标签 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |
| organizationId | UUID | 系统设置 | 创建时自动关联 | 所属组织 |

### 5. funnel_instances 表（漏斗实例）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 创建实例时 | 实例唯一标识 |
| funnelId | UUID | 用户选择 | 基于模板创建 | 关联的漏斗模板 |
| userId | UUID | 系统记录 | 创建实例 | 创建者ID |
| organizationId | UUID | 系统设置 | 创建时自动关联 | 所属组织 |
| name | VARCHAR(100) | 用户输入 | 命名实例 | 实例名称（如：2024Q1营销漏斗） |
| description | TEXT | 用户输入 | 添加说明 | 实例描述 |
| periodType | ENUM | 用户选择 | 设置周期类型 | weekly/monthly |
| periodStartDate | DATE | 用户选择 | 选择开始日期 | 数据收集开始日期 |
| periodEndDate | DATE | 用户选择 | 选择结束日期 | 数据收集结束日期 |
| status | ENUM | 用户操作/系统更新 | 更改状态 | draft/active/in_progress/completed/paused/archived |
| dataCompleteness | FLOAT | 系统计算 | 录入数据时 | 数据完整度百分比 |
| lastDataEntry | TIMESTAMPTZ | 系统记录 | 录入数据时 | 最后数据录入时间 |
| targetConversionRate | DECIMAL | 用户设置 | 设定目标 | 目标转化率 |
| targetRevenue | DECIMAL | 用户设置 | 设定目标 | 目标收入 |
| budgetAllocated | DECIMAL | 用户输入 | 分配预算 | 分配的预算 |
| tags | String[] | 用户添加 | 添加标签 | 实例标签 |
| notes | TEXT | 用户输入 | 添加备注 | 备注信息 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |
| completedAt | TIMESTAMPTZ | 系统记录 | 标记完成时 | 完成时间 |
| archivedAt | TIMESTAMPTZ | 系统记录 | 归档时 | 归档时间 |

### 6. nodes 表（漏斗节点模板）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 创建节点时 | 节点唯一标识 |
| funnelId | UUID | 系统设置 | 添加到漏斗 | 所属漏斗 |
| nodeType | ENUM | 用户选择 | 选择节点类型 | awareness/acquisition/activation/revenue/retention |
| label | VARCHAR(30) | 用户输入 | 命名节点 | 节点显示名称 |
| positionX | DECIMAL | 用户拖拽 | 移动节点 | X坐标位置 |
| positionY | DECIMAL | 用户拖拽 | 移动节点 | Y坐标位置 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |

### 7. node_instances 表（节点实例数据）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 创建实例时 | 实例唯一标识 |
| nodeId | UUID | 系统关联 | 基于模板创建 | 关联的节点模板 |
| funnelInstanceId | UUID | 系统关联 | 创建漏斗实例时 | 所属漏斗实例 |
| customLabel | VARCHAR(100) | 用户修改 | 自定义节点名称 | 实例特定的节点名称 |
| customConfig | JSON | 用户配置 | 自定义配置 | 节点特定配置 |
| currentEntryCount | INTEGER | 用户输入 | 录入进入人数 | 当前进入数量 |
| currentConvertedCount | INTEGER | 用户输入 | 录入转化人数 | 当前转化数量 |
| currentConversionRate | DECIMAL | 系统计算 | 自动计算 | 当前转化率 |
| currentRevenue | DECIMAL | 用户输入 | 录入收入 | 当前收入 |
| currentCost | DECIMAL | 用户输入 | 录入成本 | 当前成本 |
| hasData | BOOLEAN | 系统判断 | 录入数据后 | 是否有数据 |
| lastUpdated | TIMESTAMPTZ | 系统记录 | 更新数据时 | 最后更新时间 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |

### 8. edges 表（节点连接）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 连接节点时 | 连接唯一标识 |
| funnelId | UUID | 系统设置 | 创建连接 | 所属漏斗 |
| sourceNodeId | UUID | 用户拖拽 | 从源节点拖出 | 起始节点 |
| targetNodeId | UUID | 用户拖拽 | 拖到目标节点 | 目标节点 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建连接时 | 创建时间 |

---

## 指标与分析

### 9. funnel_metrics 表（漏斗整体指标）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 创建指标记录时 | 指标唯一标识 |
| funnelId | UUID | 系统关联 | 旧版本关联 | 漏斗模板ID（已废弃） |
| funnelInstanceId | UUID | 系统关联 | 新版本关联 | 漏斗实例ID |
| periodType | ENUM | 用户选择 | 设置统计周期 | weekly/monthly |
| periodStartDate | DATE | 用户选择 | 选择开始日期 | 统计开始日期 |
| periodEndDate | DATE | 用户选择 | 选择结束日期 | 统计结束日期 |
| totalEntries | INTEGER | 系统计算 | 汇总各节点数据 | 总进入数 |
| totalConversions | INTEGER | 系统计算 | 汇总转化数据 | 总转化数 |
| overallConversionRate | DECIMAL | 系统计算 | 自动计算 | 整体转化率 |
| totalRevenue | DECIMAL | 系统汇总 | 汇总收入 | 总收入 |
| totalCost | DECIMAL | 系统汇总 | 汇总成本 | 总成本 |
| roi | DECIMAL | 系统计算 | 计算投资回报率 | ROI |
| avgTimeSpent | INTEGER | 系统计算 | 计算平均时长 | 平均停留时间（秒） |
| bounceRate | DECIMAL | 系统计算 | 计算跳出率 | 跳出率 |
| notes | TEXT | 用户输入 | 添加备注 | 备注说明 |
| customMetrics | JSON | 用户定义 | 添加自定义指标 | 自定义指标数据 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |

### 10. node_metrics 表（节点指标）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 创建指标时 | 指标唯一标识 |
| nodeId | UUID | 系统关联 | 关联节点 | 节点模板ID |
| nodeInstanceId | UUID | 系统关联 | 关联节点实例 | 节点实例ID |
| periodType | ENUM | 用户选择 | 设置周期 | weekly/monthly |
| periodStartDate | DATE | 用户选择 | 选择开始日期 | 周期开始日期 |
| periodEndDate | DATE | 用户选择 | 选择结束日期 | 周期结束日期 |
| entryCount | INTEGER | 用户输入 | 录入进入数 | 进入该节点的数量 |
| exitCount | INTEGER | 用户输入 | 录入退出数 | 从该节点退出的数量 |
| convertedCount | INTEGER | 用户输入 | 录入转化数 | 转化到下一节点的数量 |
| conversionRate | DECIMAL | 系统计算 | 自动计算 | 节点转化率 |
| bounceCount | INTEGER | 用户输入 | 录入跳出数 | 跳出数量 |
| avgTimeSpent | INTEGER | 用户输入 | 录入平均时长 | 平均停留时间（秒） |
| revenue | DECIMAL | 用户输入 | 录入收入 | 节点产生的收入 |
| cost | DECIMAL | 用户输入 | 录入成本 | 节点花费的成本 |
| impressions | INTEGER | 用户输入 | 录入展示次数 | 广告展示次数 |
| clicks | INTEGER | 用户输入 | 录入点击次数 | 广告点击次数 |
| ctr | DECIMAL | 系统计算 | 计算点击率 | 点击率 |
| cpc | DECIMAL | 系统计算 | 计算单次点击成本 | CPC |
| cpm | DECIMAL | 系统计算 | 计算千次展示成本 | CPM |
| notes | TEXT | 用户输入 | 添加备注 | 备注信息 |
| customMetrics | JSON | 用户定义 | 自定义指标 | 自定义指标数据 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |

### 11. node_data 表（节点周数据-旧版）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 创建数据时 | 数据唯一标识 |
| nodeId | UUID | 系统关联 | 关联节点 | 所属节点 |
| weekStartDate | DATE | 系统设置 | 按周统计 | 周开始日期 |
| entryCount | INTEGER | 用户输入 | 录入进入数 | 本周进入数 |
| convertedCount | INTEGER | 用户输入 | 录入转化数 | 本周转化数 |
| conversionRate | DECIMAL | 系统计算 | 自动计算 | 本周转化率 |
| bounceCount | INTEGER | 用户输入 | 录入跳出数 | 本周跳出数 |
| avgTimeSpent | INTEGER | 用户输入 | 录入平均时长 | 平均停留时间 |
| revenue | DECIMAL | 用户输入 | 录入收入 | 本周收入 |
| cost | DECIMAL | 用户输入 | 录入成本 | 本周成本 |
| notes | TEXT | 用户输入 | 添加备注 | 备注信息 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |

---

## AI辅助系统

### 12. ai_sessions 表（AI会话）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 开始会话时 | 会话唯一标识 |
| userId | UUID | 系统记录 | 用户发起会话 | 会话用户 |
| funnelId | UUID | 系统关联 | 在漏斗页面发起 | 相关漏斗（旧版） |
| funnelInstanceId | UUID | 系统关联 | 在实例页面发起 | 相关漏斗实例 |
| sessionContext | ENUM | 系统判断 | 根据场景设置 | invitation/objection_handling/general |
| createdAt | TIMESTAMPTZ | 系统记录 | 开始会话 | 会话开始时间 |
| endedAt | TIMESTAMPTZ | 系统记录 | 结束会话 | 会话结束时间 |

### 13. ai_messages 表（AI消息）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 发送消息时 | 消息唯一标识 |
| sessionId | UUID | 系统关联 | 在会话中发送 | 所属会话 |
| role | ENUM | 系统设置 | 区分发送方 | user/assistant |
| content | TEXT | 用户输入/AI生成 | 发送/接收消息 | 消息内容 |
| createdAt | TIMESTAMPTZ | 系统记录 | 发送时 | 消息时间 |

### 14. user_ai_usage 表（AI使用记录）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 使用AI时 | 记录唯一标识 |
| userId | UUID | 系统记录 | 用户使用AI | 使用者ID |
| sessionId | UUID | 系统关联 | 在会话中使用 | 相关会话 |
| usageType | ENUM | 系统判断 | 根据功能分类 | chat/analysis/recommendation/general |
| requestCount | INTEGER | 系统计数 | 每次请求+1 | 请求次数 |
| tokenCount | INTEGER | 系统计算 | API返回 | Token消耗量 |
| cost | DECIMAL | 系统计算 | 根据Token计算 | 使用成本 |
| usageDate | DATE | 系统记录 | 使用日期 | 统计日期 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 记录时间 |

### 15. user_ai_limits 表（AI使用限制）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 创建限制时 | 限制唯一标识 |
| userId | UUID | 系统设置 | 为用户设置限制 | 用户ID |
| dailyLimit | INTEGER | 管理员设置 | 设置每日限额 | 每日请求限制 |
| monthlyLimit | INTEGER | 管理员设置 | 设置月度限额 | 每月请求限制 |
| currentDaily | INTEGER | 系统累加 | 使用AI时 | 当日已使用次数 |
| currentMonthly | INTEGER | 系统累加 | 使用AI时 | 当月已使用次数 |
| isActive | BOOLEAN | 管理员操作 | 启用/禁用限制 | 限制是否生效 |
| lastResetDaily | DATE | 系统重置 | 每日0点 | 上次日重置时间 |
| lastResetMonthly | DATE | 系统重置 | 每月1日 | 上次月重置时间 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |

---

## 模板与配置

### 16. funnel_templates 表（漏斗模板库）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | CUID | 系统自动生成 | 创建模板时 | 模板唯一标识 |
| name | VARCHAR(100) | 用户输入 | 命名模板 | 模板名称 |
| description | TEXT | 用户输入 | 添加描述 | 模板说明 |
| templateData | JSON | 用户设计 | 保存模板结构 | 模板数据（节点、连接等） |
| isDefault | BOOLEAN | 管理员设置 | 设为默认模板 | 是否为系统默认模板 |
| organizationId | UUID | 系统设置 | 创建时关联 | 所属组织 |
| createdBy | UUID | 系统记录 | 创建模板 | 创建者ID |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |

### 17. metric_datasets 表（指标数据集）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | CUID | 系统自动生成 | 创建数据集时 | 数据集唯一标识 |
| name | VARCHAR(100) | 用户输入 | 命名数据集 | 数据集名称 |
| datasetType | VARCHAR(50) | 用户选择 | 选择类型 | 数据集类型 |
| dataSource | VARCHAR(50) | 用户选择 | 选择数据源 | 数据来源 |
| config | JSON | 用户配置 | 配置参数 | 数据集配置 |
| organizationId | UUID | 系统设置 | 创建时关联 | 所属组织 |
| createdBy | UUID | 系统记录 | 创建数据集 | 创建者ID |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |

### 18. benchmark_data 表（行业基准数据）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | CUID | 系统自动生成 | 添加基准数据时 | 基准数据唯一标识 |
| industry | VARCHAR(100) | 管理员选择 | 选择行业 | 行业类型 |
| metricType | VARCHAR(100) | 管理员选择 | 选择指标类型 | 指标分类 |
| metricName | VARCHAR(100) | 管理员输入 | 命名指标 | 指标名称 |
| value | DECIMAL | 管理员输入 | 输入基准值 | 基准数值 |
| percentile | INTEGER | 管理员输入 | 设置百分位 | 百分位数（如P50、P90） |
| sampleSize | INTEGER | 管理员输入 | 输入样本量 | 样本数量 |
| periodStart | DATE | 管理员选择 | 选择开始日期 | 统计开始日期 |
| periodEnd | DATE | 管理员选择 | 选择结束日期 | 统计结束日期 |
| organizationId | UUID | 系统设置 | 创建时关联 | 所属组织 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |

### 19. advice_rules 表（建议规则）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | CUID | 系统自动生成 | 创建规则时 | 规则唯一标识 |
| name | VARCHAR(100) | 管理员输入 | 命名规则 | 规则名称 |
| description | TEXT | 管理员输入 | 添加描述 | 规则说明 |
| ruleType | VARCHAR(50) | 管理员选择 | 选择规则类型 | 规则分类 |
| conditions | JSON | 管理员配置 | 设置触发条件 | 规则条件 |
| advice | JSON | 管理员配置 | 设置建议内容 | 建议内容 |
| priority | INTEGER | 管理员设置 | 设置优先级 | 规则优先级 |
| isActive | BOOLEAN | 管理员操作 | 启用/禁用规则 | 规则状态 |
| organizationId | UUID | 系统设置 | 创建时关联 | 所属组织 |
| createdBy | UUID | 系统记录 | 创建规则 | 创建者ID |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |

---

## 使用限制与管理

### 20. org_usage_limits 表（组织使用限制）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | CUID | 系统自动生成 | 创建限制时 | 限制唯一标识 |
| organizationId | UUID | 系统设置 | 为组织设置 | 组织ID |
| maxFunnels | INTEGER | 管理员设置 | 设置漏斗上限 | 最大漏斗数 |
| maxTemplates | INTEGER | 管理员设置 | 设置模板上限 | 最大模板数 |
| maxInstances | INTEGER | 管理员设置 | 设置实例上限 | 最大实例数 |
| maxUsers | INTEGER | 管理员设置 | 设置用户上限 | 最大用户数 |
| currentFunnels | INTEGER | 系统计数 | 创建/删除漏斗 | 当前漏斗数 |
| currentTemplates | INTEGER | 系统计数 | 创建/删除模板 | 当前模板数 |
| currentInstances | INTEGER | 系统计数 | 创建/删除实例 | 当前实例数 |
| currentUsers | INTEGER | 系统计数 | 添加/删除用户 | 当前用户数 |
| planType | VARCHAR(20) | 用户升级 | 选择套餐 | 套餐类型 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |

### 21. admin_users 表（管理员账户）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 创建管理员时 | 管理员唯一标识 |
| username | VARCHAR(50) | 超级管理员输入 | 创建管理员账号 | 管理员用户名 |
| email | VARCHAR(255) | 超级管理员输入 | 设置管理员邮箱 | 管理员邮箱 |
| passwordHash | VARCHAR(255) | 管理员设置 | 设置密码 | 加密后的密码 |
| firstName | VARCHAR(50) | 管理员输入 | 完善信息 | 名 |
| lastName | VARCHAR(50) | 管理员输入 | 完善信息 | 姓 |
| role | ENUM | 超级管理员分配 | 分配权限 | super_admin/admin |
| isActive | BOOLEAN | 超级管理员操作 | 激活/停用账户 | 账户状态 |
| createdAt | TIMESTAMPTZ | 系统记录 | 创建时 | 创建时间 |
| updatedAt | TIMESTAMPTZ | 系统更新 | 修改时 | 更新时间 |
| lastLoginAt | TIMESTAMPTZ | 系统记录 | 登录时 | 最后登录时间 |

### 22. admin_operation_logs 表（管理操作日志）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 记录操作时 | 日志唯一标识 |
| adminId | UUID | 系统记录 | 管理员操作时 | 操作管理员ID |
| targetType | VARCHAR(50) | 系统判断 | 根据操作对象 | 操作目标类型 |
| targetId | UUID | 系统记录 | 操作具体对象 | 操作目标ID |
| operation | VARCHAR(100) | 系统记录 | 记录操作类型 | 操作名称 |
| oldValues | JSON | 系统记录 | 修改前快照 | 原始值 |
| newValues | JSON | 系统记录 | 修改后快照 | 新值 |
| result | VARCHAR(20) | 系统记录 | 操作结果 | success/failure |
| ipAddress | VARCHAR(45) | 系统获取 | 记录IP | 操作IP地址 |
| userAgent | TEXT | 系统获取 | 记录浏览器 | 浏览器信息 |
| createdAt | TIMESTAMPTZ | 系统记录 | 操作时 | 操作时间 |

---

## 审计日志

### 23. audit_log 表（审计日志）

| 字段名 | 类型 | 用户动作 | 触发场景 | 业务说明 |
|--------|------|----------|----------|----------|
| id | UUID | 系统自动生成 | 数据变更时 | 日志唯一标识 |
| tableName | VARCHAR(50) | 系统记录 | 触发器记录 | 变更的表名 |
| operation | ENUM | 系统判断 | 根据SQL操作 | INSERT/UPDATE/DELETE |
| oldValues | JSON | 系统记录 | UPDATE/DELETE时 | 原始数据 |
| newValues | JSON | 系统记录 | INSERT/UPDATE时 | 新数据 |
| userId | UUID | 系统记录 | 从会话获取 | 操作用户ID |
| timestamp | TIMESTAMPTZ | 系统记录 | 操作时 | 操作时间戳 |

---

## 用户操作流程映射

### 1. 用户注册流程
1. 用户填写注册表单 → 创建 `users` 表记录
2. 系统发送验证邮件 → 更新 `isEmailVerified` 为 false
3. 用户点击验证链接 → 更新 `isEmailVerified` 为 true
4. 用户选择/创建组织 → 更新 `organizationId`
5. 系统创建AI使用限制 → 创建 `user_ai_limits` 记录

### 2. 创建漏斗流程
1. 用户点击"新建漏斗" → 创建 `funnels` 表记录
2. 用户拖拽添加节点 → 创建 `nodes` 表记录
3. 用户连接节点 → 创建 `edges` 表记录
4. 用户保存漏斗 → 更新 `funnels.canvasData`
5. 用户设为模板 → 更新 `funnels.isTemplate` 为 true

### 3. 数据录入流程
1. 用户选择漏斗实例 → 查询 `funnel_instances`
2. 用户选择时间周期 → 设置 `periodStartDate` 和 `periodEndDate`
3. 用户输入节点数据 → 更新 `node_instances` 各字段
4. 系统计算转化率 → 更新 `currentConversionRate`
5. 系统更新完整度 → 更新 `funnel_instances.dataCompleteness`

### 4. AI辅助流程
1. 用户点击AI助手 → 创建 `ai_sessions` 记录
2. 用户发送消息 → 创建 `ai_messages` 记录（role=user）
3. AI返回响应 → 创建 `ai_messages` 记录（role=assistant）
4. 系统记录使用量 → 创建 `user_ai_usage` 记录
5. 系统更新限制计数 → 更新 `user_ai_limits.currentDaily/Monthly`

### 5. 数据分析流程
1. 用户查看分析页面 → 查询 `funnel_metrics` 和 `node_metrics`
2. 系统计算整体指标 → 汇总 `node_metrics` 到 `funnel_metrics`
3. 用户对比行业基准 → 查询 `benchmark_data`
4. 系统生成建议 → 匹配 `advice_rules` 条件
5. 用户导出报告 → 读取所有相关指标数据

---

## 权限控制映射

### 角色权限对应表

| 角色 | 可操作的表 | 允许的操作 |
|------|------------|------------|
| **Owner（所有者）** | 所有组织相关表 | 增删改查所有数据，管理成员权限 |
| **Admin（管理员）** | 除 `organizations` 设置外的所有表 | 增删改查业务数据，不能修改组织设置 |
| **Member（成员）** | `funnels`, `nodes`, `edges`, `funnel_instances`, `node_instances`, `metrics` 相关表 | 创建和编辑自己的漏斗，录入数据，查看分析 |

### 数据隔离规则

1. **组织隔离**：所有查询自动添加 `organizationId` 过滤
2. **用户隔离**：个人数据通过 `userId` 过滤
3. **实例隔离**：漏斗实例数据通过 `funnelInstanceId` 关联
4. **权限继承**：子数据继承父数据的权限设置

---

## 数据生命周期

### 数据状态流转

1. **漏斗状态**
   - `draft` → `active` → `archived`
   - 模板：`isTemplate = true` 不参与状态流转

2. **实例状态**
   - `draft` → `active` → `in_progress` → `completed` → `archived`
   - 可以从 `in_progress` → `paused` → `in_progress`

3. **数据完整性**
   - 0% → 录入数据 → 计算百分比 → 100%
   - 基于必填字段的填写情况计算

4. **审计追踪**
   - 所有数据变更自动记录到 `audit_log`
   - 管理操作记录到 `admin_operation_logs`
   - AI使用记录到 `user_ai_usage`

---

## 性能优化考虑

### 索引策略
- 主键：所有 `id` 字段
- 唯一索引：`username`, `email`, `slug`
- 外键索引：所有 `*Id` 字段
- 复合索引：`(organizationId, status)`, `(userId, createdAt)`

### 数据归档
- 超过6个月的 `completed` 实例可归档
- 归档数据移至历史表（未实现）
- 保留汇总指标供长期分析

### 缓存策略
- 行业基准数据缓存24小时
- 用户权限缓存会话期间
- AI使用限制缓存5分钟