<template>
  <div class="space-y-6">
    <div class="text-center">
      <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">
        é€‰æ‹©ä¸šåŠ¡æ¨¡æ¿
      </h3>
      <p class="text-gray-600 dark:text-gray-300">
        åŸºäºæ‚¨çš„è¡Œä¸šç±»å‹ï¼Œæˆ‘ä»¬ä¸ºæ‚¨æ¨èä»¥ä¸‹ä¸šåŠ¡æ¼æ–—æ¨¡æ¿
      </p>
    </div>

    <!-- Industry Recommended Template -->
    <div v-if="industryTemplate" class="mb-6">
      <div class="flex items-center mb-4">
        <div class="w-6 h-6 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
          </svg>
        </div>
        <h4 class="text-lg font-semibold text-gray-900 dark:text-white">ä¸ºæ‚¨æ¨è</h4>
        <span class="ml-2 px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">æ™ºèƒ½åŒ¹é…</span>
      </div>
      
      <div 
        @click="selectTemplate('industry')"
        :class="[
          'relative p-6 border-2 rounded-lg cursor-pointer transition-all bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20',
          selectedTemplate === 'industry' 
            ? 'border-blue-500 ring-2 ring-blue-200' 
            : 'border-blue-200 dark:border-blue-700 hover:border-blue-300 dark:hover:border-blue-600'
        ]"
      >
        <!-- Selected Indicator -->
        <div v-if="selectedTemplate === 'industry'" 
             class="absolute top-4 right-4 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        </div>

        <!-- Premium Badge -->
        <div class="absolute top-4 left-4 px-2 py-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-xs font-bold rounded-full">
          æ¨è
        </div>

        <div class="flex items-start space-x-4 mt-6">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
            </div>
          </div>
          <div class="flex-1">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">{{ industryTemplate.name }}</h4>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ industryTemplate.description }}</p>
            
            <!-- Nodes Preview for Industry Template -->
            <div class="mt-3 space-y-2">
              <div v-for="(node, index) in industryTemplate.nodes.slice(0, 4)" :key="node.id" 
                   class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 rounded-full mr-2" :style="{ backgroundColor: node.color }"></span>
                <span>{{ node.name }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Other Templates -->
    <div class="mb-4">
      <h4 class="text-md font-medium text-gray-700 dark:text-gray-300 mb-4">å…¶ä»–æ¨¡æ¿é€‰æ‹©</h4>
    </div>

    <!-- Template Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- E-commerce Template -->
      <div 
        @click="selectTemplate('ecommerce')"
        :class="[
          'relative p-6 border-2 rounded-lg cursor-pointer transition-all',
          selectedTemplate === 'ecommerce' 
            ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' 
            : 'border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600'
        ]"
      >
        <!-- Selected Indicator -->
        <div v-if="selectedTemplate === 'ecommerce'" 
             class="absolute top-4 right-4 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        </div>

        <div class="flex items-start space-x-4">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
            </div>
          </div>
          <div class="flex-1">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">ç”µå•†è´­ä¹°æ¼æ–—</h4>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">æ¨èç”¨äºç”µå•†ã€é›¶å”®</p>
            
            <!-- Nodes Preview -->
            <div class="mt-3 space-y-2">
              <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                <span>è®¿é—®å•†å“é¡µé¢</span>
              </div>
              <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                <span>åŠ å…¥è´­ç‰©è½¦</span>
              </div>
              <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                <span>è¿›å…¥ç»“ç®—é¡µé¢</span>
              </div>
              <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                <span>å®Œæˆæ”¯ä»˜</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SaaS Template -->
      <div 
        @click="selectTemplate('saas')"
        :class="[
          'relative p-6 border-2 rounded-lg cursor-pointer transition-all',
          selectedTemplate === 'saas' 
            ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' 
            : 'border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600'
        ]"
      >
        <!-- Selected Indicator -->
        <div v-if="selectedTemplate === 'saas'" 
             class="absolute top-4 right-4 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        </div>

        <div class="flex items-start space-x-4">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
            </div>
          </div>
          <div class="flex-1">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">SaaSæ³¨å†Œæ¼æ–—</h4>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">æ¨èç”¨äºè½¯ä»¶ã€å·¥å…·</p>
            
            <!-- Nodes Preview -->
            <div class="mt-3 space-y-2">
              <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                <span>è®¿é—®é¦–é¡µ</span>
              </div>
              <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                <span>ç‚¹å‡»æ³¨å†Œ</span>
              </div>
              <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                <span>å®Œæˆæ³¨å†Œ</span>
              </div>
              <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 bg-orange-500 rounded-full mr-2"></span>
                <span>æ¿€æ´»è¯•ç”¨</span>
              </div>
              <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                <span>ä»˜è´¹è½¬åŒ–</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Content Template -->
      <div 
        @click="selectTemplate('content')"
        :class="[
          'relative p-6 border-2 rounded-lg cursor-pointer transition-all',
          selectedTemplate === 'content' 
            ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' 
            : 'border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600'
        ]"
      >
        <!-- Selected Indicator -->
        <div v-if="selectedTemplate === 'content'" 
             class="absolute top-4 right-4 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        </div>

        <div class="flex items-start space-x-4">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
              </svg>
            </div>
          </div>
          <div class="flex-1">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">å†…å®¹è½¬åŒ–æ¼æ–—</h4>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">æ¨èç”¨äºåª’ä½“ã€å†…å®¹</p>
            
            <!-- Nodes Preview -->
            <div class="mt-3 space-y-2">
              <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                <span>æµè§ˆå†…å®¹</span>
              </div>
              <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                <span>ç‚¹å‡»äº’åŠ¨</span>
              </div>
              <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                <span>å…³æ³¨è®¢é˜…</span>
              </div>
              <div class="flex items-center text-sm text-gray-700 dark:text-gray-300">
                <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                <span>ä»˜è´¹å†…å®¹</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Custom Template -->
      <div 
        @click="selectTemplate('custom')"
        :class="[
          'relative p-6 border-2 rounded-lg cursor-pointer transition-all',
          selectedTemplate === 'custom' 
            ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' 
            : 'border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600'
        ]"
      >
        <!-- Selected Indicator -->
        <div v-if="selectedTemplate === 'custom'" 
             class="absolute top-4 right-4 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        </div>

        <div class="flex items-start space-x-4">
          <div class="flex-shrink-0">
            <div class="w-12 h-12 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" />
              </svg>
            </div>
          </div>
          <div class="flex-1">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">è‡ªå®šä¹‰æ¼æ–—</h4>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">å®Œå…¨è‡ªå®šä¹‰æµç¨‹</p>
            
            <!-- Custom Description -->
            <div class="mt-3">
              <p class="text-sm text-gray-600 dark:text-gray-400">
                æ ¹æ®æ‚¨çš„å…·ä½“ä¸šåŠ¡éœ€æ±‚ï¼Œè‡ªå®šä¹‰è®¾ç½®æ¼æ–—èŠ‚ç‚¹å’Œè½¬åŒ–è·¯å¾„
              </p>
              <div class="mt-2 flex items-center text-sm text-blue-600 dark:text-blue-400">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                <span>ä»ç©ºç™½å¼€å§‹æ„å»º</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-center mt-8 space-x-4">
      <button
        v-if="!funnelCreated"
        @click="handleSetupFunnel"
        :disabled="!selectedTemplate"
        class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center"
      >
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
        </svg>
        è®¾ç½®æ¼æ–—ï¼ˆå¯é€‰ï¼‰
      </button>
      <button
        @click="handleSkip"
        :class="[
          'px-6 py-3 rounded-lg font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors',
          funnelCreated 
            ? 'bg-green-600 hover:bg-green-700 text-white focus:ring-green-500' 
            : 'bg-gray-200 hover:bg-gray-300 text-gray-700 focus:ring-gray-500'
        ]"
      >
        {{ funnelCreated ? 'å®Œæˆè®¾ç½®' : 'ç¨åè®¾ç½®' }}
      </button>
    </div>
    
    <!-- Status indicator -->
    <div v-if="funnelCreated" class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg text-center">
      <div class="flex items-center justify-center text-green-700">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        <span class="text-sm font-medium">æ¼æ–—åˆ›å»ºæˆåŠŸï¼ç°åœ¨å¯ä»¥ç»§ç»­å®Œæˆåˆå§‹åŒ–</span>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useAppStore } from '@stores/app'

// Define props for v-model
interface Props {
  modelValue?: string
  organization?: {
    name: string
    industry: string
    size: string
    description: string
    location: string
    salesModel: string
  }
}

const props = withDefaults(defineProps<Props>(), {
  organization: () => ({
    name: '',
    industry: '',
    size: '',
    description: '',
    location: '',
    salesModel: ''
  })
})

const emit = defineEmits<{
  'update:modelValue': [value: string]
}>()

const router = useRouter()
const appStore = useAppStore()

// Use a local ref for internal state
const internalSelectedTemplate = ref<string>(props.modelValue || '')
const funnelCreated = ref(false)

// Watch for external changes
watch(() => props.modelValue, (newValue) => {
  if (newValue !== undefined) {
    internalSelectedTemplate.value = newValue
  }
})

// Computed property for template
const selectedTemplate = computed({
  get: () => internalSelectedTemplate.value,
  set: (value) => {
    internalSelectedTemplate.value = value
    emit('update:modelValue', value)
  }
})


// è¡Œä¸šä¸“å±æ¨¡æ¿é…ç½®
const industryTemplates = {
  'technology': {
    name: 'ç§‘æŠ€/äº’è”ç½‘æ¼æ–—',
    description: 'é€‚ç”¨äºç§‘æŠ€å…¬å¸å’Œäº’è”ç½‘äº§å“çš„ç”¨æˆ·è½¬åŒ–æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'è®¿é—®äº§å“é¡µ', type: 'start', label: 'è®¿é—®äº§å“é¡µ', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'æ³¨å†Œè¯•ç”¨', type: 'stage', label: 'æ³¨å†Œè¯•ç”¨', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'äº§å“ä½“éªŒ', type: 'stage', label: 'äº§å“ä½“éªŒ', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'ä»˜è´¹è½¬åŒ–', type: 'end', label: 'ä»˜è´¹è½¬åŒ–', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'finance': {
    name: 'é‡‘è/ä¿é™©æ¼æ–—',
    description: 'é€‚ç”¨äºé‡‘èå’Œä¿é™©è¡Œä¸šçš„å®¢æˆ·è½¬åŒ–æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'äº†è§£äº§å“', type: 'start', label: 'äº†è§£äº§å“', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'å’¨è¯¢æœåŠ¡', type: 'stage', label: 'å’¨è¯¢æœåŠ¡', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'é£é™©è¯„ä¼°', type: 'stage', label: 'é£é™©è¯„ä¼°', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'ç­¾çº¦è´­ä¹°', type: 'end', label: 'ç­¾çº¦è´­ä¹°', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'healthcare': {
    name: 'åŒ»ç–—å¥åº·æ¼æ–—',
    description: 'é€‚ç”¨äºåŒ»ç–—å¥åº·è¡Œä¸šçš„æ‚£è€…æœåŠ¡æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'ç—‡çŠ¶å’¨è¯¢', type: 'start', label: 'ç—‡çŠ¶å’¨è¯¢', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'é¢„çº¦æŒ‚å·', type: 'stage', label: 'é¢„çº¦æŒ‚å·', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'è¯Šæ–­æ²»ç–—', type: 'stage', label: 'è¯Šæ–­æ²»ç–—', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'åº·å¤éšè®¿', type: 'end', label: 'åº·å¤éšè®¿', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'education': {
    name: 'æ•™è‚²åŸ¹è®­æ¼æ–—',
    description: 'é€‚ç”¨äºæ•™è‚²åŸ¹è®­è¡Œä¸šçš„å­¦å‘˜è½¬åŒ–æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'äº†è§£è¯¾ç¨‹', type: 'start', label: 'äº†è§£è¯¾ç¨‹', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'è¯•å¬ä½“éªŒ', type: 'stage', label: 'è¯•å¬ä½“éªŒ', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'æŠ¥åç¼´è´¹', type: 'stage', label: 'æŠ¥åç¼´è´¹', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'å®Œæˆå­¦ä¹ ', type: 'end', label: 'å®Œæˆå­¦ä¹ ', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'ecommerce': {
    name: 'ç”µå•†/é›¶å”®æ¼æ–—',
    description: 'é€‚ç”¨äºç”µå•†é›¶å”®è¡Œä¸šçš„è´­ä¹°è½¬åŒ–æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'å•†å“æµè§ˆ', type: 'start', label: 'å•†å“æµè§ˆ', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'åŠ å…¥è´­ç‰©è½¦', type: 'stage', label: 'åŠ å…¥è´­ç‰©è½¦', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'ç¡®è®¤è®¢å•', type: 'stage', label: 'ç¡®è®¤è®¢å•', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'æ”¯ä»˜å®Œæˆ', type: 'end', label: 'æ”¯ä»˜å®Œæˆ', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'manufacturing': {
    name: 'åˆ¶é€ ä¸šæ¼æ–—',
    description: 'é€‚ç”¨äºåˆ¶é€ ä¸šçš„å®¢æˆ·è·å–æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'äº§å“è¯¢ä»·', type: 'start', label: 'äº§å“è¯¢ä»·', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'æŠ€æœ¯æ²Ÿé€š', type: 'stage', label: 'æŠ€æœ¯æ²Ÿé€š', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'æŠ¥ä»·è°ˆåˆ¤', type: 'stage', label: 'æŠ¥ä»·è°ˆåˆ¤', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'ç­¾çº¦åˆä½œ', type: 'end', label: 'ç­¾çº¦åˆä½œ', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'consulting': {
    name: 'å’¨è¯¢æœåŠ¡æ¼æ–—',
    description: 'é€‚ç”¨äºå’¨è¯¢æœåŠ¡è¡Œä¸šçš„å®¢æˆ·è·å–æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'éœ€æ±‚å’¨è¯¢', type: 'start', label: 'éœ€æ±‚å’¨è¯¢', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'æ–¹æ¡ˆè®¨è®º', type: 'stage', label: 'æ–¹æ¡ˆè®¨è®º', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'ææ¡ˆæŠ¥ä»·', type: 'stage', label: 'ææ¡ˆæŠ¥ä»·', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'ç­¾çº¦æœåŠ¡', type: 'end', label: 'ç­¾çº¦æœåŠ¡', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'media': {
    name: 'åª’ä½“/å¹¿å‘Šæ¼æ–—',
    description: 'é€‚ç”¨äºåª’ä½“å¹¿å‘Šè¡Œä¸šçš„å®¢æˆ·è½¬åŒ–æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'å†…å®¹æ›å…‰', type: 'start', label: 'å†…å®¹æ›å…‰', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'äº’åŠ¨å‚ä¸', type: 'stage', label: 'äº’åŠ¨å‚ä¸', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'å¹¿å‘ŠæŠ•æ”¾', type: 'stage', label: 'å¹¿å‘ŠæŠ•æ”¾', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'å“ç‰Œè½¬åŒ–', type: 'end', label: 'å“ç‰Œè½¬åŒ–', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'real_estate': {
    name: 'æˆ¿åœ°äº§æ¼æ–—',
    description: 'é€‚ç”¨äºæˆ¿åœ°äº§è¡Œä¸šçš„å®¢æˆ·è½¬åŒ–æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'æˆ¿æºæµè§ˆ', type: 'start', label: 'æˆ¿æºæµè§ˆ', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'å®åœ°çœ‹æˆ¿', type: 'stage', label: 'å®åœ°çœ‹æˆ¿', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'æ„å‘æ´½è°ˆ', type: 'stage', label: 'æ„å‘æ´½è°ˆ', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'ç­¾çº¦æˆäº¤', type: 'end', label: 'ç­¾çº¦æˆäº¤', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'travel': {
    name: 'æ—…æ¸¸/é…’åº—æ¼æ–—',
    description: 'é€‚ç”¨äºæ—…æ¸¸é…’åº—è¡Œä¸šçš„å®¢æˆ·é¢„è®¢æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'æµè§ˆäº§å“', type: 'start', label: 'æµè§ˆäº§å“', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'æ¯”è¾ƒé€‰æ‹©', type: 'stage', label: 'æ¯”è¾ƒé€‰æ‹©', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'ä¸‹å•é¢„è®¢', type: 'stage', label: 'ä¸‹å•é¢„è®¢', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'ç¡®è®¤å…¥ä½', type: 'end', label: 'ç¡®è®¤å…¥ä½', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'automotive': {
    name: 'æ±½è½¦è¡Œä¸šæ¼æ–—',
    description: 'é€‚ç”¨äºæ±½è½¦è¡Œä¸šçš„å®¢æˆ·è´­ä¹°æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'å“ç‰Œå…³æ³¨', type: 'start', label: 'å“ç‰Œå…³æ³¨', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'è¯•é©¾ä½“éªŒ', type: 'stage', label: 'è¯•é©¾ä½“éªŒ', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'é…ç½®é€‰æ‹©', type: 'stage', label: 'é…ç½®é€‰æ‹©', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'è´­è½¦æˆäº¤', type: 'end', label: 'è´­è½¦æˆäº¤', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'food': {
    name: 'é¤é¥®/é£Ÿå“æ¼æ–—',
    description: 'é€‚ç”¨äºé¤é¥®é£Ÿå“è¡Œä¸šçš„å®¢æˆ·æ¶ˆè´¹æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'äº†è§£å“ç‰Œ', type: 'start', label: 'äº†è§£å“ç‰Œ', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'èœå“é€‰æ‹©', type: 'stage', label: 'èœå“é€‰æ‹©', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'ä¸‹å•æ”¯ä»˜', type: 'stage', label: 'ä¸‹å•æ”¯ä»˜', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'å®Œæˆæ¶ˆè´¹', type: 'end', label: 'å®Œæˆæ¶ˆè´¹', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'logistics': {
    name: 'ç‰©æµ/è¿è¾“æ¼æ–—',
    description: 'é€‚ç”¨äºç‰©æµè¿è¾“è¡Œä¸šçš„å®¢æˆ·æœåŠ¡æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'è¿è¾“éœ€æ±‚', type: 'start', label: 'è¿è¾“éœ€æ±‚', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'æ–¹æ¡ˆæŠ¥ä»·', type: 'stage', label: 'æ–¹æ¡ˆæŠ¥ä»·', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'ç­¾è®¢åˆåŒ', type: 'stage', label: 'ç­¾è®¢åˆåŒ', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'æœåŠ¡äº¤ä»˜', type: 'end', label: 'æœåŠ¡äº¤ä»˜', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'energy': {
    name: 'èƒ½æºè¡Œä¸šæ¼æ–—',
    description: 'é€‚ç”¨äºèƒ½æºè¡Œä¸šçš„å®¢æˆ·è·å–æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'éœ€æ±‚è¯„ä¼°', type: 'start', label: 'éœ€æ±‚è¯„ä¼°', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'æ–¹æ¡ˆè®¾è®¡', type: 'stage', label: 'æ–¹æ¡ˆè®¾è®¡', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'åˆåŒè°ˆåˆ¤', type: 'stage', label: 'åˆåŒè°ˆåˆ¤', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'é¡¹ç›®äº¤ä»˜', type: 'end', label: 'é¡¹ç›®äº¤ä»˜', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'government': {
    name: 'æ”¿åºœ/å…¬å…±æ¼æ–—',
    description: 'é€‚ç”¨äºæ”¿åºœå’Œå…¬å…±æœåŠ¡çš„æ°‘ä¼—æœåŠ¡æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'æœåŠ¡å’¨è¯¢', type: 'start', label: 'æœåŠ¡å’¨è¯¢', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'ææ–™æäº¤', type: 'stage', label: 'ææ–™æäº¤', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'å®¡æ ¸å¤„ç†', type: 'stage', label: 'å®¡æ ¸å¤„ç†', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'æœåŠ¡å®Œæˆ', type: 'end', label: 'æœåŠ¡å®Œæˆ', color: '#EF4444', x: 700, y: 200 }
    ]
  },
  'other': {
    name: 'é€šç”¨ä¸šåŠ¡æ¼æ–—',
    description: 'é€‚ç”¨äºå„ç§è¡Œä¸šçš„é€šç”¨ä¸šåŠ¡æµç¨‹æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'å®¢æˆ·æ¥è§¦', type: 'start', label: 'å®¢æˆ·æ¥è§¦', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'éœ€æ±‚æ²Ÿé€š', type: 'stage', label: 'éœ€æ±‚æ²Ÿé€š', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'æ–¹æ¡ˆç¡®è®¤', type: 'stage', label: 'æ–¹æ¡ˆç¡®è®¤', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'æœåŠ¡äº¤ä»˜', type: 'end', label: 'æœåŠ¡äº¤ä»˜', color: '#EF4444', x: 700, y: 200 }
    ]
  }
}

// åŠ¨æ€ç”Ÿæˆè¡Œä¸šç›¸å…³æ¨¡æ¿
const industryTemplate = computed(() => {
  console.log('ğŸ­ Computing industry template:', props.organization)
  
  if (!props.organization?.industry) {
    console.log('ğŸ­ No industry specified in organization')
    return null
  }
  
  const industry = props.organization.industry
  const industryConfig = industryTemplates[industry as keyof typeof industryTemplates]
  
  console.log('ğŸ­ Industry template mapping:', {
    industry,
    hasConfig: !!industryConfig
  })
  
  if (!industryConfig) {
    console.log('ğŸ­ No specific template for this industry')
    return null
  }
  
  // ä¸ºèŠ‚ç‚¹æ·»åŠ è¿æ¥é…ç½®
  const nodes = industryConfig.nodes
  const connections = nodes.slice(0, -1).map((node, index) => ({
    id: `conn_${index + 1}`,
    source: node.id,
    target: nodes[index + 1].id
  }))
  
  const result = {
    id: 'industry',
    name: industryConfig.name,
    description: industryConfig.description,
    nodes,
    connections
  }
  
  console.log('ğŸ­ Generated industry template:', result)
  return result
})

const selectTemplate = (template: string) => {
  console.log('Selecting template:', template)
  internalSelectedTemplate.value = template
  emit('update:modelValue', template)
}

// Template configurations with proper node types
const templates = {
  ecommerce: {
    name: 'ç”µå•†è´­ä¹°æ¼æ–—',
    description: 'é€‚ç”¨äºç”µå•†å¹³å°çš„è´­ä¹°è½¬åŒ–æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'è®¿é—®å•†å“é¡µé¢', type: 'start', label: 'è®¿é—®å•†å“é¡µé¢', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'åŠ å…¥è´­ç‰©è½¦', type: 'stage', label: 'åŠ å…¥è´­ç‰©è½¦', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'è¿›å…¥ç»“ç®—é¡µé¢', type: 'stage', label: 'è¿›å…¥ç»“ç®—é¡µé¢', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'å®Œæˆæ”¯ä»˜', type: 'end', label: 'å®Œæˆæ”¯ä»˜', color: '#EF4444', x: 700, y: 200 }
    ],
    connections: [
      { id: 'conn_1', source: 'node_1', target: 'node_2' },
      { id: 'conn_2', source: 'node_2', target: 'node_3' },
      { id: 'conn_3', source: 'node_3', target: 'node_4' }
    ]
  },
  saas: {
    name: 'SaaSæ³¨å†Œæ¼æ–—',
    description: 'é€‚ç”¨äºSaaSäº§å“çš„ç”¨æˆ·è½¬åŒ–æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'è®¿é—®é¦–é¡µ', type: 'start', label: 'è®¿é—®é¦–é¡µ', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'ç‚¹å‡»æ³¨å†Œ', type: 'stage', label: 'ç‚¹å‡»æ³¨å†Œ', color: '#3B82F6', x: 300, y: 200 },
      { id: 'node_3', name: 'å®Œæˆæ³¨å†Œ', type: 'stage', label: 'å®Œæˆæ³¨å†Œ', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'æ¿€æ´»è¯•ç”¨', type: 'action', label: 'æ¿€æ´»è¯•ç”¨', color: '#8B5CF6', x: 700, y: 200 },
      { id: 'node_5', name: 'ä»˜è´¹è½¬åŒ–', type: 'end', label: 'ä»˜è´¹è½¬åŒ–', color: '#EF4444', x: 900, y: 200 }
    ],
    connections: [
      { id: 'conn_1', source: 'node_1', target: 'node_2' },
      { id: 'conn_2', source: 'node_2', target: 'node_3' },
      { id: 'conn_3', source: 'node_3', target: 'node_4' },
      { id: 'conn_4', source: 'node_4', target: 'node_5' }
    ]
  },
  content: {
    name: 'å†…å®¹è½¬åŒ–æ¼æ–—',
    description: 'é€‚ç”¨äºå†…å®¹å¹³å°çš„ç”¨æˆ·è½¬åŒ–æ¼æ–—',
    nodes: [
      { id: 'node_1', name: 'æµè§ˆå†…å®¹', type: 'start', label: 'æµè§ˆå†…å®¹', color: '#10B981', x: 100, y: 200 },
      { id: 'node_2', name: 'ç‚¹å‡»äº’åŠ¨', type: 'action', label: 'ç‚¹å‡»äº’åŠ¨', color: '#8B5CF6', x: 300, y: 200 },
      { id: 'node_3', name: 'å…³æ³¨è®¢é˜…', type: 'stage', label: 'å…³æ³¨è®¢é˜…', color: '#F59E0B', x: 500, y: 200 },
      { id: 'node_4', name: 'ä»˜è´¹å†…å®¹', type: 'end', label: 'ä»˜è´¹å†…å®¹', color: '#EF4444', x: 700, y: 200 }
    ],
    connections: [
      { id: 'conn_1', source: 'node_1', target: 'node_2' },
      { id: 'conn_2', source: 'node_2', target: 'node_3' },
      { id: 'conn_3', source: 'node_3', target: 'node_4' }
    ]
  },
  custom: {
    name: 'è‡ªå®šä¹‰æ¼æ–—',
    description: 'ä»ç©ºç™½å¼€å§‹åˆ›å»ºè‡ªå®šä¹‰æ¼æ–—',
    nodes: [],
    connections: []
  }
}

const handleSetupFunnel = async () => {
  if (!selectedTemplate.value) return

  let template
  if (selectedTemplate.value === 'industry' && industryTemplate.value) {
    template = industryTemplate.value
  } else {
    template = templates[selectedTemplate.value as keyof typeof templates]
  }
  
  if (!template) return
  
  console.log('ğŸš€ FunnelTemplateSelection handleSetupFunnel called:', {
    selectedTemplate: selectedTemplate.value,
    template: template.name
  })
  
  // Store template and onboarding state in sessionStorage
  sessionStorage.setItem('funnelTemplate', JSON.stringify(template))
  sessionStorage.setItem('onboardingReturn', 'true')
  sessionStorage.setItem('onboardingTemplate', selectedTemplate.value)
  
  // Also save current organization data if available
  const orgData = sessionStorage.getItem('onboardingOrgData')
  if (!orgData && props.organization) {
    sessionStorage.setItem('onboardingOrgData', JSON.stringify(props.organization))
    console.log('ğŸ’¾ Saved organization data before navigating:', props.organization)
  }
  
  // Show success message
  appStore.showSuccess('æ¨¡æ¿å·²é€‰æ‹©', `å·²é€‰æ‹©${template.name}ï¼Œæ­£åœ¨è¿›å…¥ç¼–è¾‘é¡µé¢...`)
  
  console.log('ğŸš€ FunnelTemplateSelection navigating to:', '/funnels/create')
  
  // Navigate to funnel builder with return parameter
  router.push({
    path: '/funnels/create',
    query: { from: 'onboarding' }
  })
}

const handleSkip = async () => {
  // Mark onboarding as complete
  sessionStorage.setItem('onboardingComplete', 'true')
  
  // If funnel was created, we're on the "å®Œæˆè®¾ç½®" button
  if (funnelCreated.value) {
    // Set a flag so parent knows funnel was created
    sessionStorage.setItem('onboardingReturnComplete', 'true')
    // The parent (Onboarding) will handle the navigation
    // Don't navigate here, let the parent handle it
    return
  }
  
  // User clicked "ç¨åè®¾ç½®" - skip funnel creation
  // Clean up any temporary storage
  sessionStorage.removeItem('onboardingReturnComplete')
  sessionStorage.removeItem('onboardingReturn')
  sessionStorage.removeItem('funnelTemplate')
  
  // Show success message
  appStore.showSuccess('åˆå§‹åŒ–å®Œæˆ', 'æ¬¢è¿ä½¿ç”¨ Pathfinderï¼')
  
  // Navigate to dashboard
  router.push('/dashboard')
}

const handleNext = async () => {
  if (!selectedTemplate.value) return

  let template
  if (selectedTemplate.value === 'industry' && industryTemplate.value) {
    template = industryTemplate.value
  } else {
    template = templates[selectedTemplate.value as keyof typeof templates]
  }
  
  if (!template) return
  
  // Store template in sessionStorage for the builder to use
  sessionStorage.setItem('funnelTemplate', JSON.stringify(template))
  
  // Show success message
  appStore.showSuccess('æ¨¡æ¿å·²é€‰æ‹©', `å·²é€‰æ‹©${template.name}ï¼Œæ­£åœ¨è¿›å…¥ç¼–è¾‘é¡µé¢...`)
  
  // Navigate to funnel builder with template
  router.push('/funnels/create')
}

// Check if returning from funnel creation
onMounted(() => {
  const templateFromStorage = sessionStorage.getItem('onboardingTemplate')
  const returnFlag = sessionStorage.getItem('onboardingReturnComplete')
  
  if (returnFlag === 'true' && templateFromStorage) {
    // User is returning after creating funnel
    // Set funnel created state to show success message
    funnelCreated.value = true
    selectedTemplate.value = templateFromStorage
    
    // Don't clean up session storage here - let the parent (Onboarding.vue) handle it
    // Don't auto-redirect - let the user click the "å®Œæˆè®¾ç½®" button
    return
  }
})

// Expose for parent component
defineExpose({
  selectedTemplate: computed(() => selectedTemplate.value),
  handleNext,
  handleSkip
})
</script>